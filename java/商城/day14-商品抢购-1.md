# day14-商品抢购

#学习目标

分析秒杀业务,了解秒杀流程

搭建秒杀工程,完成对秒杀的管理

定时任务生成秒杀静态页面

#1.  秒杀业务分析
##1.1 需求分析
所谓“秒杀”，就是网络卖家发布一些超低价格的商品，所有买家在同一时间网上抢购的一种销售方式。

通俗一点讲就是网络商家为促销等目的组织的网上限时抢购活动。由于商品价格低廉，往往一上架就被抢购一空。

秒杀商品通常有两种限制：库存限制、时间限制。

需求：

```properties
（1）商家后台录入秒杀商品数据，主要包括：商品标题、原价、秒杀价、开始时间、结束时间、商品图片、介绍等信息
（2）秒杀频道首页列出秒杀商品（进行中的）点击秒杀商品图片跳转到秒杀商品详细页。
（3）商品详细页显示秒杀商品信息，点击立即抢购实现秒杀下单，下单时扣减库存。当库存为0或不在活动期范围内时无法秒杀。
（4）填写收货地址、电话、收件人等信息,秒杀下单成功，转到成功页，直接跳转到支付页面（微信扫码），支付成功，完成订单。
（5）当用户秒杀下单5分钟内未支付，取消预订单，调用关闭订单接口，恢复库存。
```

## 1.2. 秒杀的特点和解决方案介绍

1）、秒杀活动只是网站营销的一个小活动，但是秒杀却具有：时间短、并发访问量大的特点，我们需要保证秒杀业务正常更不能影响网站原有业务。

解决方案：将秒杀系统独立部署，甚至使用独立域名，使其与网站完全隔离。

2）、秒杀活动的请求量大，并发高。如果按照一般的网站应用架构，先访问应用服务器、再连接数据库，会对应用服务器和数据库服务器造成负载压力。

解决方案：服务端限流、使用缓存。重新设计秒杀商品页面，页面内容静态化，页面请求不要经过应用服务

3）、“超卖”问题。由于对库存的并发操作导致售出数量多于库存数量，引起卖家的商品卖得件数超过秒杀的设置件数

解决方案：使用队列或者分布式锁、数据库使用悲观锁或者乐观锁

4）、防刷机制。防止用户端使用机器访问秒杀服务。

解决方案：使用秒杀验证器。最简单的有：校验码，复杂的可以使用：秒杀答题，提出一个不（很）常（变）见（态）的问题，用户回答，答案正确了才能进行秒杀。

##1.3 数据库表分析

### 1.3.1秒杀政策表（秒杀商品表）

```sql
/**秒杀商品信息表  spu+sku**/
CREATE TABLE `tb_seckill_policy` (
  `id` bigint(20) NOT NULL AUTO_INCREMENT,
  `spu_id` bigint(20) NOT NULL COMMENT 'spu id',
  `cid1` bigint(20) NOT NULL COMMENT '1级类目id',
  `cid2` bigint(20) NOT NULL COMMENT '2级类目id',
  `cid3` bigint(20) NOT NULL COMMENT '3级类目id',
  `brand_id` bigint(20) NOT NULL COMMENT '商品所属品牌id',
  `sku_id` bigint(20) NOT NULL COMMENT 'sku ID',
  `title` varchar(100) NOT NULL COMMENT '标题',
  `sub_title` varchar(100) NOT NULL COMMENT '标题',
  `num` int(11) NOT NULL COMMENT '秒杀商品数',
  `stock_count` int(11) unsigned NOT NULL COMMENT '剩余库存数',
  `sku_pic` varchar(150) NOT NULL COMMENT '商品图片',
  `old_price` bigint(20) NOT NULL COMMENT '原价格',
  `cost_price` bigint(20) NOT NULL COMMENT '秒杀价格',
  `begin_time` timestamp NOT NULL DEFAULT '0000-00-00 00:00:00' COMMENT '开始时间',
  `end_time` timestamp NOT NULL DEFAULT '0000-00-00 00:00:00' COMMENT '结束时间',
  `create_time` timestamp NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `update_time` timestamp NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '最后修改时间',
  `name` varchar(50) NOT NULL COMMENT 'spu名称',
  `sec_kill_date` varchar(11) NOT NULL COMMENT '秒杀日期',
  PRIMARY KEY (`id`),
  UNIQUE KEY `unique_sku_id_begin` (`sku_id`,`begin_time`),
  KEY `key_sku_id` (`sku_id`) USING BTREE
) ENGINE=InnoDB AUTO_INCREMENT=18 DEFAULT CHARSET=utf8 COMMENT='秒杀政策表';
```

### 1.3.2秒杀订单详情表

```sql
CREATE TABLE `tb_order_seckill_detail` (
  `id` bigint(20) NOT NULL AUTO_INCREMENT COMMENT '订单详情id ',
  `order_id` bigint(20) NOT NULL COMMENT '订单id',
  `seckill_id` bigint(20) NOT NULL COMMENT 'sku商品id',
  `num` int(11) NOT NULL COMMENT '购买数量',
  `create_time` timestamp NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `update_time` timestamp NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  KEY `key_order_id` (`order_id`) USING BTREE
) ENGINE=InnoDB DEFAULT CHARSET=utf8 COMMENT='秒杀订单详情表'
```



##1.4 秒杀实现思路
秒杀的核心方案是： 缓存、静态化、限流、异步



#2. 工程搭建准备


##2.1. 创建ly-seckill工程

创建ly-seckill工程，这个工程主要处理秒杀的后台管理和前端请求

注意：这是一个父工程，pom文件如下：

```xml
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
    <parent>
        <artifactId>leyou</artifactId>
        <groupId>com.leyou</groupId>
        <version>1.0-SNAPSHOT</version>
    </parent>
    <modelVersion>4.0.0</modelVersion>

    <artifactId>ly-seckill</artifactId>
    <packaging>pom</packaging>
  
</project>
```



## 2.2. 创建ly-seckill-pojo子工程

创建ly-seckill-pojo存放pojo对象，pom.xml如下：

```xml
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
    <parent>
        <artifactId>ly-seckill</artifactId>
        <groupId>com.leyou</groupId>
        <version>1.0-SNAPSHOT</version>
    </parent>
    <modelVersion>4.0.0</modelVersion>

    <artifactId>ly-seckill-pojo</artifactId>
    <dependencies>
            <!--格式化时间、忽略生成json-->
            <dependency>
                <groupId>com.fasterxml.jackson.core</groupId>
                <artifactId>jackson-annotations</artifactId>
                <version>2.9.0</version>
                <scope>compile</scope>
            </dependency>
        </dependencies>

</project>
```

创建SeckillPolicyDTO.java

```java
package com.leyou.seckill.pojo;

import com.fasterxml.jackson.annotation.JsonFormat;
import com.fasterxml.jackson.annotation.JsonIgnore;
import lombok.Data;
import lombok.EqualsAndHashCode;
import lombok.experimental.Accessors;

import java.util.Arrays;
import java.util.Date;
import java.util.List;

@Data
@EqualsAndHashCode(callSuper = false)
@Accessors(chain = true)
public class SeckillPolicyDTO {
    private Long id;
    private Long spuId;
    private String name;
    private Long cid1;
    private Long cid2;
    private Long cid3;
    private Long brandId;
    private Long skuId;
    private String title;
    private String subTitle;
    private Integer num;
    private Integer stockCount;
    private String skuPic;
    private Long oldPrice;
    private Long costPrice;
    @JsonFormat(pattern="yyyy-MM-dd HH:mm:ss",timezone="GMT+8")
    private Date beginTime;
    @JsonFormat(pattern="yyyy-MM-dd HH:mm:ss",timezone="GMT+8")
    private Date endTime;
    private String secKillDate;
    private String brandName;
    private String categoryName;
    @JsonIgnore
    public List<Long> getCategorys() {
        return Arrays.asList(cid1, cid2, cid3);
    }

}

```

## 2.3. 创建ly-seckill-interface子工程

pom.xml

```xml
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
    <parent>
        <artifactId>ly-seckill</artifactId>
        <groupId>com.leyou</groupId>
        <version>1.0-SNAPSHOT</version>
    </parent>
    <modelVersion>4.0.0</modelVersion>

    <artifactId>ly-seckill-interface</artifactId>

    <dependencies>
        <dependency>
            <groupId>com.leyou</groupId>
            <artifactId>ly-seckill-pojo</artifactId>
            <version>1.0-SNAPSHOT</version>
        </dependency>
        <dependency>
            <groupId>org.springframework.cloud</groupId>
            <artifactId>spring-cloud-openfeign-core</artifactId>
        </dependency>
    </dependencies>

</project>
```

##2.4. 创建ly-seckill-service子工程

创建秒杀服务模块ly-seckill-service秒杀的业务逻辑都写在这个服务里，pom.xml如下：

###2.4.1. pom.xml
```xml
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
    <parent>
        <artifactId>ly-seckill</artifactId>
        <groupId>com.leyou</groupId>
        <version>1.0-SNAPSHOT</version>
    </parent>
    <modelVersion>4.0.0</modelVersion>

    <artifactId>ly-seckill-service</artifactId>


    <dependencies>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-web</artifactId>
        </dependency>
        <dependency>
            <groupId>org.springframework.cloud</groupId>
            <artifactId>spring-cloud-starter-netflix-eureka-client</artifactId>
        </dependency>
        <dependency>
            <groupId>mysql</groupId>
            <artifactId>mysql-connector-java</artifactId>
        </dependency>
        <dependency>
            <groupId>com.baomidou</groupId>
            <artifactId>mybatis-plus-boot-starter</artifactId>
        </dependency>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-test</artifactId>
        </dependency>
        <dependency>
            <groupId>org.apache.rocketmq</groupId>
            <artifactId>rocketmq-spring-boot-starter</artifactId>
            <version>2.0.2</version>
        </dependency>
        <dependency>
            <groupId>org.springframework.cloud</groupId>
            <artifactId>spring-cloud-starter-openfeign</artifactId>
        </dependency>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-data-redis</artifactId>
        </dependency>
        <dependency>
            <groupId>com.leyou</groupId>
            <artifactId>ly-order-pojo</artifactId>
            <version>1.0-SNAPSHOT</version>
        </dependency>
        <dependency>
            <groupId>com.leyou</groupId>
            <artifactId>ly-seckill-pojo</artifactId>
            <version>1.0-SNAPSHOT</version>
        </dependency>
        <dependency>
            <groupId>com.leyou</groupId>
            <artifactId>ly-item-interface</artifactId>
            <version>1.0-SNAPSHOT</version>
        </dependency>
        <dependency>
            <groupId>com.leyou</groupId>
            <artifactId>ly-common</artifactId>
            <version>1.0-SNAPSHOT</version>
        </dependency>
    </dependencies>
    <build>
        <plugins>
            <plugin>
                <groupId>org.springframework.boot</groupId>
                <artifactId>spring-boot-maven-plugin</artifactId>
            </plugin>
        </plugins>
    </build>

</project>
```

### 2.4.2. application.yml

```yaml
server:
  port: 8092
spring:
  application:
    name: seckill-service
  datasource:
    driver-class-name: com.mysql.jdbc.Driver
    url: jdbc:mysql:///leyou?characterEncoding=UTF-8
    username: root
    password: 123456
  redis:
    host: 127.0.0.1
eureka:
  client:
    service-url:
      defaultZone: http://127.0.0.1:10086/eureka
    registry-fetch-interval-seconds: 5
#MyBatisPlus
mybatis-plus:
  configuration:
    log-impl: org.apache.ibatis.logging.stdout.StdOutImpl #输出sql日志  
rocketmq:
  name-server: 127.0.0.1:9876
  producer:
    group: ${spring.application.name}
```

###2.4.3. 启动类

```java
package com.leyou;

import org.mybatis.spring.annotation.MapperScan;
import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.cloud.client.discovery.EnableDiscoveryClient;

@SpringBootApplication
@EnableDiscoveryClient
@EnableFeignClients
@MapperScan("com.leyou.seckill.mapper")
public class LySecKillApplication {
    public static void main(String[] args) {
        SpringApplication.run(LySecKillApplication.class,args);
    }
}

```

### 2.4.4. MyBatisPlus分页配置

```java
package com.leyou.seckill.config;

import com.baomidou.mybatisplus.extension.plugins.PaginationInterceptor;
import com.baomidou.mybatisplus.extension.plugins.PerformanceInterceptor;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;

@Configuration
public class MyBatisPlusConfig {

    /**
     * @Description : mybatis-plus分页插件
     */
    @Bean
    public PaginationInterceptor paginationInterceptor() {
        return new PaginationInterceptor();
    }

    /***
     * plus 的性能优化
     * @return
     */
    @Bean
    public PerformanceInterceptor performanceInterceptor() {
        PerformanceInterceptor performanceInterceptor = new PerformanceInterceptor();
        /*<!--SQL是否格式化 默认false-->*/
        performanceInterceptor.setFormat(true);
        return performanceInterceptor;
    }


}
```

### 2.4.5. 实体类

```java
package com.leyou.seckill.entity;

import com.baomidou.mybatisplus.annotation.IdType;
import com.baomidou.mybatisplus.annotation.TableId;
import com.baomidou.mybatisplus.extension.activerecord.Model;
import lombok.Data;
import lombok.EqualsAndHashCode;
import lombok.experimental.Accessors;

import java.io.Serializable;
import java.util.Date;

/**
 * <p>
 * 秒杀政策表
 * </p>
 *
 * @author HM
 */
@Data
@EqualsAndHashCode(callSuper = false)
@Accessors(chain = true)
public class TbSeckillPolicy extends Model<TbSeckillPolicy> {

private static final long serialVersionUID=1L;

   @TableId(value = "id", type = IdType.AUTO)
    private Long id;

    /**
     * spu id
     */
    private Long spuId;
    /**
     * spu名称
     */
    private String name;

    /**
     * 1级类目id
     */
    private Long cid1;

    /**
     * 2级类目id
     */
    private Long cid2;

    /**
     * 3级类目id
     */
    private Long cid3;

    /**
     * 商品所属品牌id
     */
    private Long brandId;

    /**
     * sku ID
     */
    private Long skuId;

    /**
     * 标题
     */
    private String title;
    /**
     * 促销信息
     */
    private String subTitle;

    /**
     * 秒杀商品数
     */
    private Integer num;

    /**
     * 剩余库存数
     */
    private Integer stockCount;

    /**
     * 商品图片
     */
    private String skuPic;

    /**
     * 原价格
     */
    private Long oldPrice;

    /**
     * 秒杀价格
     */
    private Long costPrice;

    /**
     * 开始时间
     */
    private Date beginTime;

    /**
     * 结束时间
     */
    private Date endTime;

    /**
     * 秒杀 日期
     */
    private String secKillDate;

    /**
     * 创建时间
     */
    private Date createTime;

    /**
     * 最后修改时间
     */
    private Date updateTime;


    @Override
    protected Serializable pkVal() {
        return this.id;
    }

}

```

### 2.4.6. mapper

```java
package com.leyou.seckill.mapper;

import com.baomidou.mybatisplus.core.mapper.BaseMapper;
import com.leyou.seckill.entity.TbSeckillPolicy;

/**
 * <p>
 * 秒杀政策表 Mapper 接口
 * </p>
 *
 * @author HM
 */
public interface TbSeckillPolicyMapper extends BaseMapper<TbSeckillPolicy> {

}

```

### 2.4.7. service

TbSeckillPolicyService.java

```java
package com.leyou.seckill.service;

import com.baomidou.mybatisplus.extension.service.IService;
import com.leyou.seckill.entity.TbSeckillPolicy;

/**
 * <p>
 * 秒杀政策表 服务类
 * </p>
 *
 * @author HM
 */
public interface TbSeckillPolicyService extends IService<TbSeckillPolicy> {

}

```

TbSeckillPolicyServiceImpl

```java
package com.leyou.seckill.service.impl;

import com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;
import com.leyou.seckill.entity.TbSeckillPolicy;
import com.leyou.seckill.mapper.TbSeckillPolicyMapper;
import com.leyou.seckill.service.TbSeckillPolicyService;
import org.springframework.stereotype.Service;

/**
 * <p>
 * 秒杀政策表 服务实现类
 * </p>
 *
 * @author HM
 */
@Service
public class TbSeckillPolicyServiceImpl extends ServiceImpl<TbSeckillPolicyMapper, TbSeckillPolicy> implements TbSeckillPolicyService {

}

```

### 2.4.9  创建请求拦截器

```java
package com.leyou.seckill.interceptors;

import com.leyou.common.auth.entity.Payload;
import com.leyou.common.auth.entity.UserInfo;
import com.leyou.common.auth.utils.JwtUtils;
import com.leyou.common.threadlocals.UserHolder;
import com.leyou.common.utils.CookieUtils;
import lombok.extern.slf4j.Slf4j;
import org.springframework.web.servlet.HandlerInterceptor;

import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;

@Slf4j
public class UserInterceptor implements HandlerInterceptor {

/**
     * 获取token
     * 解析token，获取用户信息
     * 把userid 放入threadlocal
     * @param request
     * @param response
     * @param handler
     * @return
     * @throws Exception
     */
    @Override
    public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) throws Exception {
        try{
//        获取用户token
            String token = CookieUtils.getCookieValue(request, "LY_TOKEN");
//        解析token
            Payload<UserInfo> payload = JwtUtils.getInfoFromToken(token, UserInfo.class);
//        ，获取用户信息
            UserInfo userInfo = payload.getUserInfo();
            Long userId = userInfo.getId();
//            把用户信息放入userHolder
            UserHolder.setUser(userId);
            return true;
        }catch(Exception e){
            e.printStackTrace();
            // 解析失败，不继续向下
            log.error("【秒杀】解析用户信息失败！", e);
            return false;
        }

    }

    /**
     * 删除threadlocal中的数据
     * @param request
     * @param response
     * @param handler
     * @param ex
     * @throws Exception
     */
    @Override
    public void afterCompletion(HttpServletRequest request, HttpServletResponse response, Object handler, Exception ex) throws Exception {
        UserHolder.removeUser();

    }
}

```

### 2.4.10 注册拦截器

```java
package com.leyou.seckill.config;

import com.leyou.seckill.interceptor.UserInterceptors;
import org.springframework.context.annotation.Configuration;
import org.springframework.web.servlet.config.annotation.InterceptorRegistry;
import org.springframework.web.servlet.config.annotation.WebMvcConfigurer;

@Configuration
public class MvcConfig implements WebMvcConfigurer {

    @Override
    public void addInterceptors(InterceptorRegistry registry) {
        registry.addInterceptor(new UserInterceptor()).addPathPatterns("/portal/addSecKillOrder/**");//只拦截秒杀的前端请求，验证token
    }
}

```

## 从这里开始

## 2.5.配置网关

在application.yml中的zuul.routes 添加路由映射

```yml
    seckill-service: /seckillgoods/** #前端秒杀使用
    seckillManage-service:            #后端秒杀管理使用
      path: /manageSec/**
      serviceId: seckill-service
```

添加白名单

```yml
ly:
  filter:
    allowPaths:
	  - /api/auth/login
      - /api/search
      - /api/user/register
      - /api/user/check
      - /api/user/code
      - /api/item
      - /api/manageSec     #放行秒杀后台请求
```

工程目录如下：

![1575862574536](assets/1575862574536.png)





#3. 管理后台管理秒杀信息

![1578642213342](assets/1578642213342.png)



## 3.1 SecKillController代码

在ly-seckill-service 工程创建

SecKillController.java代码：

```java
package com.leyou.seckill.controller;

import com.leyou.common.vo.PageResult;
import com.leyou.seckill.dto.SeckillPolicyDTO;
import com.leyou.seckill.entity.TbSeckillPolicy;
import com.leyou.seckill.service.SecKillService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.*;

/**
 * 秒杀 后台管理操作
 *
 * @author
 */
@RestController
public class SecKillController {
    @Autowired
    private SecKillService secKillService;

    /**
     * 分页查询 秒杀商品
     *
     * @param page
     * @param rows
     * @param key
     * @param state 1-未开始 2-进行中  3-已结束
     * @return
     */
    @GetMapping("/findSecKillPage")
    public ResponseEntity<PageResult<SeckillPolicyDTO>> findSecKillByPage(@RequestParam(name = "page", defaultValue = "1") Integer page,
                                                                          @RequestParam(name = "rows", defaultValue = "5") Integer rows,
                                                                          @RequestParam(name = "key", required = false) String key,
                                                                          @RequestParam(name = "state", required = false) Integer state) {
        return ResponseEntity.ok(secKillService.findSecKillByPage(page, rows, key, state));
    }

    /**
     * 根据id查询秒杀信息
     *
     * @param id
     * @return
     */
    @GetMapping("/{id}")
    public ResponseEntity<SeckillPolicyDTO> findSecKillPolicyById(@PathVariable(name = "id") Long id) {
        return ResponseEntity.ok(secKillService.findSecKillById(id));
    }

    /**
     * 添加秒杀商品
     *
     * @param seckillPolicy
     * @return
     */
    @PostMapping
    public ResponseEntity<Void> addSecKill(@RequestBody TbSeckillPolicy seckillPolicy) {
        secKillService.addSecKill(seckillPolicy);
        return ResponseEntity.status(HttpStatus.NO_CONTENT).build();
    }

    /**
     * 修改秒杀商品
     *
     * @param seckillPolicy
     * @return
     */
    @PutMapping
    public ResponseEntity<Void> updateSecKill(@RequestBody TbSeckillPolicy seckillPolicy) {
        secKillService.updateSecKill(seckillPolicy);
        return ResponseEntity.status(HttpStatus.NO_CONTENT).build();
    }

    /**
     * 删除秒杀商品
     *
     * @param id
     * @return
     */
    @DeleteMapping("/{id}")
    public ResponseEntity<Void> deleteSecKill(@PathVariable(name = "id") Long id) {
        secKillService.deleteSecKill(id);
        return ResponseEntity.status(HttpStatus.NO_CONTENT).build();
    }

}

```

## 3.2 SecKillService代码

```java
package com.leyou.seckill.service;

import com.baomidou.mybatisplus.core.conditions.query.QueryWrapper;
import com.baomidou.mybatisplus.core.metadata.IPage;
import com.baomidou.mybatisplus.extension.plugins.pagination.Page;
import com.leyou.common.enums.ExceptionEnum;
import com.leyou.common.exceptions.LyException;
import com.leyou.common.utils.BeanHelper;
import com.leyou.common.vo.PageResult;
import com.leyou.item.client.ItemClient;
import com.leyou.item.dto.BrandDTO;
import com.leyou.item.dto.CategoryDTO;
import com.leyou.seckill.dto.SeckillPolicyDTO;
import com.leyou.seckill.entity.TbSeckillPolicy;
import lombok.extern.slf4j.Slf4j;
import org.joda.time.DateTime;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
import org.springframework.util.CollectionUtils;
import org.springframework.util.StringUtils;

import java.util.Date;
import java.util.List;
import java.util.Map;
import java.util.stream.Collectors;

/**
 * 秒杀管理平台业务
 * @author
 */
@Slf4j
@Service
public class SecKillService {
    @Autowired
    private TbSeckillPolicyService tbSeckillPolicyService;
    @Autowired
    private ItemClient itemClient;

    /**
     * 分页查询 秒杀信息
     *
     * @param page
     * @param rows
     * @param key
     * @param state 1-未开始 2-进行中  3-已结束
     * @return
     */
    public PageResult<SeckillPolicyDTO> findSecKillByPage(Integer page, Integer rows, String key, Integer state) {

        IPage<TbSeckillPolicy> page1 = new Page<>(page, rows);
        QueryWrapper<TbSeckillPolicy> queryWrapper = new QueryWrapper<>();
        if (!StringUtils.isEmpty(key)) {
            queryWrapper.lambda().like(TbSeckillPolicy::getTitle, key);
        }
        if (state != null) {
            Date now = new Date();
            switch (state) {
                case 1:
                    queryWrapper.lambda().gt(TbSeckillPolicy::getBeginTime, now);
                    break;
                case 2:
                    queryWrapper.lambda().lt(TbSeckillPolicy::getBeginTime, now).gt(TbSeckillPolicy::getEndTime, now);
                    break;
                case 3:
                    queryWrapper.lambda().lt(TbSeckillPolicy::getEndTime, now);
                    break;

            }
        }
        queryWrapper.orderByAsc("begin_time");
        IPage<TbSeckillPolicy> policyIPage = tbSeckillPolicyService.page(page1, queryWrapper);
        if (policyIPage == null || CollectionUtils.isEmpty(policyIPage.getRecords())) {
            throw new LyException(ExceptionEnum.SECKILL_NOT_FOUND);
        }

        List<TbSeckillPolicy> tbSeckillPolicyList = policyIPage.getRecords();
        List<SeckillPolicyDTO> seckillPolicyDTOS = BeanHelper.copyWithCollection(tbSeckillPolicyList, SeckillPolicyDTO.class);
        this.handleCategoryAndBrandName(seckillPolicyDTOS);
        return new PageResult<SeckillPolicyDTO>(seckillPolicyDTOS,policyIPage.getTotal(), policyIPage.getPages());
    }

    /**
     * 处理 品牌名称 和 分类名称
     *
     * @param seckillPolicyDTOS
     */
    private void handleCategoryAndBrandName(List<SeckillPolicyDTO> seckillPolicyDTOS) {

        for (SeckillPolicyDTO seckillPolicyDTO : seckillPolicyDTOS) {
            //通过brandId查询brandName
            Long brandId = seckillPolicyDTO.getBrandId();
            BrandDTO brandDTO = itemClient.findBrandById(brandId);
            seckillPolicyDTO.setBrandName(brandDTO.getName());
            //查询categoryName  结果如 ：手机/手机通讯/手机    1级分类名/2级分类名/3级分类名
            List<Long> cids = seckillPolicyDTO.getCategorys();
            List<CategoryDTO> categoryDTOList = itemClient.findCategoryListByIds(cids);
            String categoryNames = categoryDTOList.stream().map(CategoryDTO::getName).collect(Collectors.joining("/"));
            seckillPolicyDTO.setCategoryName(categoryNames);
        }
    }

    /**
     * 根据id 查询 秒杀信息
     *
     * @param id
     * @return
     */
    public SeckillPolicyDTO findSecKillById(Long id) {
        TbSeckillPolicy tbSeckillPolicy = tbSeckillPolicyService.getById(id);
        if (tbSeckillPolicy == null) {
            throw new LyException(ExceptionEnum.SECKILL_NOT_FOUND);
        }
        return BeanHelper.copyProperties(tbSeckillPolicy, SeckillPolicyDTO.class);
    }

    /**
     * 添加秒杀商品信息
     *
     * @param seckillPolicy
     */
    public void addSecKill(TbSeckillPolicy seckillPolicy) {
        //获取秒杀日期 yyyy-MM-dd
        String secKillDay = new DateTime(seckillPolicy.getBeginTime()).toString("yyyy-MM-dd");
//        设置秒杀库存
        seckillPolicy.setStockCount(seckillPolicy.getNum());
//        设置秒杀 结束时间，默认为 开始2个小时后结束
        Date endTime = new DateTime(seckillPolicy.getBeginTime()).plusHours(2).toDate();
        seckillPolicy.setEndTime(endTime);
//        设置秒杀 日期
        seckillPolicy.setSecKillDate(secKillDay);
        boolean b = tbSeckillPolicyService.save(seckillPolicy);
        if (!b) {
            throw new LyException(ExceptionEnum.INSERT_OPERATION_FAIL);
        }

    }

    /**
     * 修改秒杀信息
     *
     * @param seckillPolicy
     */
    public void updateSecKill(TbSeckillPolicy seckillPolicy) {
        //获取秒杀日期 yyyy-MM-dd
        String secKillDay = new DateTime(seckillPolicy.getBeginTime()).toString("yyyy-MM-dd");
        // 设置秒杀库存
        seckillPolicy.setStockCount(seckillPolicy.getNum());
//        设置秒杀 结束时间，默认为 开始2个小时后结束
        Date endTime = new DateTime(seckillPolicy.getBeginTime()).plusHours(2).toDate();
        seckillPolicy.setEndTime(endTime);
        //        设置秒杀 日期
        seckillPolicy.setSecKillDate(secKillDay);
        boolean b = tbSeckillPolicyService.updateById(seckillPolicy);
        if (!b) {
            throw new LyException(ExceptionEnum.UPDATE_OPERATION_FAIL);
        }

    }

    /**
     * 删除 秒杀信息
     *
     * @param id
     */
    public void deleteSecKill(Long id) {
//        先把要删除的数据查询出来
        TbSeckillPolicy tbSeckillPolicy = tbSeckillPolicyService.getById(id);
        boolean b = tbSeckillPolicyService.removeById(id);
        if (!b) {
            throw new LyException(ExceptionEnum.DELETE_OPERATION_FAIL);
        }
    }
}

```

添加异常枚举内容

```java
SECKILL_NOT_FOUND(404,"秒杀信息不存在！"),
SECKILL_END_ERROR(400,"抢购已结束！"),
SECKILL_ALREADY_JOIN_ERROR(400,"当前参与用户过多，请求稍后重试！"),
```



## 3.3 ly-item-service提供方法

![1578642056647](assets/1578642056647.png)

在GoodsController.java添加方法

```java
/**
     * 根据brandid查询商品
     * @param brandId
     * @param cid3
     * @return
     */
    @GetMapping("/spu/for/brand")
    public ResponseEntity<List<SpuDTO>> findSpuByBrandId(@RequestParam(name = "id") Long brandId,
                                                         @RequestParam(name = "cid") Long cid3){
        return ResponseEntity.ok(goodsService.findSpuByBrandId(brandId,cid3));
    }
```

在GoodsService.java添加方法

```java
/**
     * 根据brandId查询商品列表
     *
     * @param brandId
     * @param cid3
     * @return
     */
    public List<SpuDTO> findSpuByBrandId(Long brandId, Long cid3) {
        QueryWrapper<TbSpu> queryWrapper = new QueryWrapper<>();
        queryWrapper.lambda().eq(TbSpu::getBrandId, brandId).eq(TbSpu::getCid3, cid3);
        List<TbSpu> tbSpuList = spuService.list(queryWrapper);
        return BeanHelper.copyWithCollection(tbSpuList, SpuDTO.class);
    }
```



# 4. 定时生成秒杀列表页

## 4.1 ly-task-servie发起定时任务

定时任务启动后，发送MQ消息，消息内容为 要生成秒杀页面的 日期。

在**ly-task-service**工程中，创建GenerateSecKillPageTask.java

```java
package com.leyou.task.job;

import org.apache.rocketmq.spring.core.RocketMQTemplate;
import org.joda.time.DateTime;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.scheduling.annotation.Scheduled;
import org.springframework.stereotype.Component;

import static com.leyou.common.constants.RocketMQConstants.TAGS.SECKILL_BEGIN_TAGS;
import static com.leyou.common.constants.RocketMQConstants.TOPIC.SECKILL_TOPIC_NAME;

/**
 * 秒杀 业务 定时任务
 */
@Component
public class GenerateSecKillPageTask {
    @Autowired
    private RocketMQTemplate rocketMQTemplate;

    /**
     * 秒杀开始任务
     * 每天的 每隔30秒生成当天的静态页面
     */
    @Scheduled(cron = "0/30 * * * * ?")
    public void doBeginSeckillTask() {
//        获取日期
        String today = DateTime.now().toString("yyyy-MM-dd");
//        发送生成秒杀页面的定时任务，消息内容是：日期
        rocketMQTemplate.convertAndSend(SECKILL_TOPIC_NAME + ":" + SECKILL_BEGIN_TAGS, today);
    }
}
```



## 4.2 在ly-page生成秒杀静态页面

### 4.2.1 在ly-page添加依赖

```xml
<dependency>
    <groupId>com.leyou</groupId>
    <artifactId>ly-seckill-interface</artifactId>
    <version>1.0-SNAPSHOT</version>
</dependency>
```

### 4.2.2 准备静态页面所需的模板

模板页面需要两个，一个用来生成秒杀列表页面，一个用来生成秒杀详情页面

把今天资料中的两个html文件拷贝到templates下

![1578638292079](assets/1578638292079.png)

秒杀列表页的 模板名称为 seckill-index.html，秒杀详情页的模板名为 seckill-item.html

文件目录如下：

![1575861479645](assets/1575861479645.png)



### 4.2.3 监听MQ消息生成静态页面

在ly-page工程中的listener包下，创建SecKillBeginListener.java

```java
package com.leyou.page.listener;

import com.leyou.page.service.PageService;
import lombok.extern.slf4j.Slf4j;
import org.apache.rocketmq.spring.annotation.RocketMQMessageListener;
import org.apache.rocketmq.spring.core.RocketMQListener;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Component;

import static com.leyou.common.constants.RocketMQConstants.CONSUMER.SECKILL_BEGIN_CONSUMER;
import static com.leyou.common.constants.RocketMQConstants.TAGS.SECKILL_BEGIN_TAGS;
import static com.leyou.common.constants.RocketMQConstants.TOPIC.SECKILL_TOPIC_NAME;

/**
 * 秒杀业务  监听
 */
@Slf4j
@Component
@RocketMQMessageListener(topic = SECKILL_TOPIC_NAME,
        selectorExpression = SECKILL_BEGIN_TAGS,
        consumerGroup = SECKILL_BEGIN_CONSUMER)
public class SecKillBeginListener implements RocketMQListener<String> {
    @Autowired
    private PageService pageService;

    /**
     * 监听 创建秒杀列表和详情页 消息
     *
     * @param date
     */
    @Override
    public void onMessage(String date) {
        log.info("[静态页服务] - 秒杀开始 接收到消息 : 时间：{}", date);
        pageService.createSecKillListAndDetailHtml(date);

    }
}

```



### 4.2.4 ly-seckill-interface提供接口

根据秒杀日期获取秒杀商品

#### 添加feign接口

```java
package com.leyou.seckill.client;

import com.leyou.seckill.dto.SeckillPolicyDTO;
import org.springframework.cloud.openfeign.FeignClient;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PathVariable;

import java.util.List;


@FeignClient("seckill-service")
public interface SeckillClient {
    /**
     * 获取 当天的 秒杀列表
     * @return
     */
    @GetMapping("/list/{date}")
    List<SeckillPolicyDTO> findSecKillPolicyList(@PathVariable(name = "date")String date);

}

```

#### SeckillController添加方法

```java
@GetMapping("/list/{date}")
public ResponseEntity<List<SeckillPolicyDTO>> findSecKillPolicyList(@PathVariable(name = "date")String date){
    List<SeckillPolicyDTO> seckillPolicyDTOList = secKillService.findSecKillPolicyList(date);
    return ResponseEntity.ok(seckillPolicyDTOList);
}
```

#### seckillService添加方法

```java
public List<SeckillPolicyDTO> findSecKillPolicyList(String date) {
    //        获取 当天的 秒杀列表
    QueryWrapper<TbSeckillPolicy> queryWrapper = new QueryWrapper<>();
    queryWrapper.lambda().eq(TbSeckillPolicy::getSecKillDate, date);
    List<TbSeckillPolicy> tbSeckillPolicyList = tbSeckillPolicyService.list(queryWrapper);
    if (CollectionUtils.isEmpty(tbSeckillPolicyList)) {
        throw new LyException(ExceptionEnum.SECKILL_NOT_FOUND);
    }
    return BeanHelper.copyWithCollection(tbSeckillPolicyList, SeckillPolicyDTO.class);
}
```

### 4.2.5 PageService 添加代码如下

分析：

1、seckill-index.html页面中所需的数据是seckillList，秒杀商品的集合

2、seckill-item.html页面中所需要的数据是

```
detail --------------spuDetail spu的详情
seckillgoods---------秒杀商品
specs----------------带规格参数的规格组集合
```

```java
@Autowired
private TemplateEngine templateEngine;


@Autowired
    private SecKillClient secKillClient;

    private String secKillFilePath = "C:\\workspace\\heima-jee121\\nginx-1.12.2\\html\\seckill";
    /**
     * 生成 秒杀的列表 和 详情
     * @param date
     */
    public void createSecKillListAndDetailHtml(String date) {

//        从seckill中获取秒杀的列表
        List<SeckillPolicyDTO> secKillPolicyList = secKillClient.findSecKillPolicyList(date);
        this.createSecKillLisHtml(secKillPolicyList);
        for (SeckillPolicyDTO seckillPolicyDTO : secKillPolicyList) {
            this.createSeckillDetailHtml(seckillPolicyDTO);
        }


    }

    private void createSeckillDetailHtml(SeckillPolicyDTO seckillPolicyDTO) {
        //       秒杀规则id
        Long secKillId = seckillPolicyDTO.getId();
        //        模板上下文
        Context context = new Context();
        //获取秒杀商品的规格参数信息
        Map<String, Object> itemData = loadSecKillDetailData(seckillPolicyDTO);
        //设置 动态数据
        context.setVariables(itemData);
        //        模板目录,nginx下的html下的seckill
        File dir = new File(secKillFilePath);
        if(!dir.exists()){
            dir.mkdir();
        }
        //        要生成的文件名
        File itemFile = new File(dir,secKillId+".html");
        PrintWriter printWriter = null;
        try {
            printWriter = new PrintWriter(itemFile,"UTF-8");
            //详情页模板名称为 seckill-item
            templateEngine.process("seckill-item",context,printWriter);
        } catch (Exception e) {
            e.printStackTrace();
        }finally {
            printWriter.close();
        }
    }
     /**
     * 获取秒杀详情信息，商品的规格参数
     * @param seckillPolicyDTO 秒杀 规则对象
     * @return
     */
    public Map<String, Object> loadSecKillDetailData(SeckillPolicyDTO seckillPolicyDTO) {
        Map<String,Object> map = new HashMap<>();
        Long spuId = seckillPolicyDTO.getSpuId();
        //获取spu detail
        SpuDetailDTO spuDetailDTO = itemClient.findSpuDetailBySpuId(spuId);
        //规格组 和 组内规格
        List<SpecGroupDTO> specGroupDTOList = itemClient.findSpecsByCid(seckillPolicyDTO.getCid3());
        map.put("seckillgoods",seckillPolicyDTO);
        map.put("detail",spuDetailDTO);
        map.put("specs",specGroupDTOList);
        return map;
    }
    /**
     *
     * @param secKillPolicyList
     */
    private void createSecKillLisHtml(List<SeckillPolicyDTO> secKillPolicyList) {
        Context context = new Context();
        Map<String,Object> map = new HashMap<>();
        map.put("seckillList",secKillPolicyList);
        context.setVariables(map);
        File dir = new File(secKillFilePath);
        if(!dir.exists()){
            dir.mkdir();
        }
        PrintWriter writer = null;
        try{
            File file = new File(dir, "list.html");
            writer = new PrintWriter(file,"UTF-8");
            templateEngine.process("seckill-index",context,writer);
        }catch(Exception e){
            e.printStackTrace();
        }finally {
            writer.close();
        }
    }
```



## 4.3 秒杀商品列表页面的处理

### 4.3.1 跳转到秒杀列表页面

![1578644714000](assets/1578644714000.png)

#### 第一步：修改top.js

![1578644917211](assets/1578644917211.png)

#### 第二步：修改Nginx配置文件

```
location /seckill {
	    root html;	    
}
```



![1578644838373](assets/1578644838373.png)

#### 第三步：测试

![1578760758119](assets/1578760758119.png)

没有显示“立即抢购”这样的按钮，因为需要一个获取后台服务器当前时间的方法。

![1578760094064](assets/1578760094064.png)

### 4.3.2 从服务端获取当前时间

说明：

整个乐优商城采用分布式架构，意味着需要有很多台服务器部署代码，但是因为种种原因每台服务器的时间都很难统一，都会有些许的差别，所以以后想获取时间，我们让同一台服务返回时间，我们暂时可以让ly-task微服务提供时间。也就意味着ly-task-interface对外提供feign接口来提供时间服务

#### 创建TimeController

在ly-task-service中创建TimeController.java

这个时间服务，其他工程都从这个服务获取时间，避免因各个服务器时间不同而产生的问题。尤其是定时任务，需要在一个固定时间来执行时，对时间的准确有较高要求。

```java
package com.leyou.task.controller;

import org.joda.time.DateTime;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;

@RestController
public class TimeController {
    /**
     * 获取当前时间
     * @return
     */
    @GetMapping("/getTime")
    public ResponseEntity<String> getTime(){

        return ResponseEntity.ok(DateTime.now().toString("yyyy-MM-dd HH:mm:ss"));
    }

    /**
     * 获取当前日期
     * @return
     */
    @GetMapping("/getToday")
    public ResponseEntity<String> getToday(){

        return ResponseEntity.ok(DateTime.now().toString("yyyy-MM-dd"));
    }

    /**
     * 获取昨天日期
     * @return
     */
    @GetMapping("/getYesterday")
    ResponseEntity<String> getYesterday(){
        return ResponseEntity.ok(DateTime.now().minusDays(1).toString("yyyy-MM-dd"));
    }
}



```

### 4.3.3.创建ly-task-interface

提供获取的 feign的接口

####  pom.xml

```xml
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
    <parent>
        <artifactId>ly-task</artifactId>
        <groupId>com.leyou</groupId>
        <version>1.0-SNAPSHOT</version>
    </parent>
    <modelVersion>4.0.0</modelVersion>

    <artifactId>ly-task-interface</artifactId>
    <dependencies>
        <dependency>
            <groupId>org.springframework.cloud</groupId>
            <artifactId>spring-cloud-openfeign-core</artifactId>
            <scope>compile</scope>
        </dependency>
    </dependencies>


</project>
```

### 4.3.4. TimeClient接口

```java
package com.leyou.task.client;

import org.springframework.cloud.openfeign.FeignClient;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.GetMapping;

@FeignClient("task-service")
public interface TimeClient {
    /**
     * 获取当前时间
     * @return
     */
    @GetMapping("/getTime")
    String getTime();

    /**
     * 获取当前日期
     * @return
     */
    @GetMapping("/getToday")
    String getToday();

    /**
     * 获取昨天日期
     * @return
     */
    @GetMapping("/getYesterday")
    String getYesterday();
}

```

整个工程目录如下：

![1575862512594](assets/1575862512594.png)



### 4.3.5 在秒杀微服务中调用 ly-task-interface提供的方法



第一步：在ly-seckill-service中添加依赖

```xml
<dependency>
    <groupId>com.leyou</groupId>
    <artifactId>ly-task-interface</artifactId>
    <version>1.0-SNAPSHOT</version>
</dependency>
```

第二步：在ly-seckill-service创建一个处理静态页面发来请求的controller

创建SecKillPortalController，添加代码

```java
package com.leyou.seckill.controller;

import com.leyou.task.client.TimeClient;
import com.leyou.seckill.service.SeckillPortalService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.GetMapping;

@RestController
public class SecKillPortalController {
    /**
     * 获取当前时间，返回给前端，做倒计时用
     * 格式为 yyyy-MM-dd HH:mm:ss
     * @return
     */
    @Autowired
    private TimeClient timeClient;

    @GetMapping("/portal/time")
    public ResponseEntity<String> getTime(){
        return ResponseEntity.ok(timeClient.getTime());
    }
}

```



随便打开一个秒杀商品的详情页面，也会出现倒计时效果

![1578654358157](assets/1578654358157.png)




