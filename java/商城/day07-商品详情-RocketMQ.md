# å­¦ä¹ ç›®æ ‡

- äº†è§£Thymeleafçš„åŸºæœ¬ä½¿ç”¨
- å®ç°å•†å“è¯¦æƒ…é¡µåŠ¨æ€é¡µé¢
- å®ç°å•†å“è¯¦æƒ…é¡µé¢é™æ€åŒ–
- äº†è§£RocketMQçš„åŸºæœ¬ä½¿ç”¨
- äº†è§£RocketMQçš„æ¶ˆæ¯
- äº†è§£SpringBootæ•´åˆRocketMQ



# 1ã€å•†å“è¯¦æƒ…-Thymeleafå…¥é—¨

### é‡ç‚¹ï¼šäº†è§£Thymeleafä½¿ç”¨ï¼Œå®ç°é™æ€é¡µé¢çš„ç”Ÿæˆ

## 1.1 å•†å“è¯¦æƒ…å®ç°æ€è·¯

å½“ç”¨æˆ·æœç´¢åˆ°å•†å“ï¼Œè‚¯å®šä¼šç‚¹å‡»æŸ¥çœ‹ï¼Œå°±ä¼šè¿›å…¥å•†å“è¯¦æƒ…é¡µï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å®Œæˆå•†å“è¯¦æƒ…é¡µçš„å±•ç¤ºï¼Œå•†å“è¯¦æƒ…é¡µåœ¨leyou-portalä¸­å¯¹åº”çš„é¡µé¢æ˜¯ï¼šitem.html

ä½†æ˜¯ä¸åŒçš„å•†å“ï¼Œåˆ°è¾¾item.htmléœ€è¦å±•ç¤ºçš„å†…å®¹ä¸åŒï¼Œè¯¥æ€ä¹ˆåšå‘¢ï¼Ÿ

- æ€è·¯1ï¼šç»Ÿä¸€è·³è½¬åˆ°item.htmlé¡µé¢ï¼Œç„¶åå¼‚æ­¥åŠ è½½å•†å“æ•°æ®ï¼Œæ¸²æŸ“é¡µé¢
- æ€è·¯2ï¼šå°†è¯·æ±‚äº¤ç»™tomcatå¤„ç†ï¼Œåœ¨æœåŠ¡ç«¯å®Œæˆæ•°æ®æ¸²æŸ“ï¼Œç»™ä¸åŒå•†å“ç”Ÿæˆä¸åŒé¡µé¢åï¼Œè¿”å›ç»™ç”¨æˆ·

æˆ‘ä»¬è¯¥é€‰å“ªä¸€ç§æ€è·¯ï¼Ÿ

æ€è·¯1ï¼š

- ä¼˜ç‚¹ï¼šé¡µé¢åŠ è½½å¿«ï¼Œå¼‚æ­¥å¤„ç†ï¼Œç”¨æˆ·ä½“éªŒå¥½
- ç¼ºç‚¹ï¼šä¼šå‘æœåŠ¡ç«¯å‘èµ·å¤šæ¬¡æ•°æ®è¯·æ±‚ï¼Œå¢åŠ æœåŠ¡ç«¯å‹åŠ›

æ€è·¯2ï¼š

- ä¼˜ç‚¹ï¼šæœåŠ¡ç«¯å¤„ç†é¡µé¢åè¿”å›ï¼Œç”¨æˆ·æ‹¿åˆ°æ˜¯æœ€ç»ˆé¡µé¢ï¼Œä¸ä¼šå†æ¬¡å‘æœåŠ¡ç«¯å‘èµ·æ•°æ®è¯·æ±‚ã€‚
- ç¼ºç‚¹ï¼šåœ¨æœåŠ¡ç«¯å¤„ç†é¡µé¢ï¼ŒæœåŠ¡ç«¯å‹åŠ›è¿‡å¤§ï¼Œtomcatå¹¶å‘èƒ½åŠ›å·®



å¯¹äºå¤§å‹ç”µå•†ç½‘ç«™è€Œè¨€ï¼Œå¿…é¡»è¦è€ƒè™‘çš„å°±æ˜¯æœåŠ¡çš„é«˜å¹¶å‘é—®é¢˜ï¼Œå› æ­¤è¦å°½å¯èƒ½å‡å°‘æœåŠ¡ç«¯å‹åŠ›ï¼Œæé«˜æœåŠ¡å“åº”é€Ÿåº¦ï¼Œæ‰€ä»¥è¿™é‡Œæˆ‘ä»¬ä¸¤ä¸ªæ–¹æ¡ˆéƒ½ä¸ä¼šç”¨ï¼Œæˆ‘ä»¬é‡‡ç”¨æ–¹æ¡ˆ3ï¼š

æ–¹æ¡ˆ3ï¼šé¡µé¢é™æ€åŒ–

é¡µé¢é™æ€åŒ–ï¼šé¡¾åæ€ä¹‰ï¼Œå°±æ˜¯æŠŠæœ¬æ¥éœ€è¦åŠ¨æ€æ¸²æŸ“çš„é¡µé¢æå‰æ¸²æŸ“å®Œæˆï¼Œç”Ÿæˆé™æ€çš„HTMLï¼Œå½“ç”¨æˆ·è®¿é—®æ—¶ç›´æ¥è¯»å–é™æ€HTMLï¼Œæé«˜å“åº”é€Ÿåº¦ï¼Œå‡è½»æœåŠ¡ç«¯å‹åŠ›ã€‚

è¿™ç§æ–¹å¼ä¸æ–¹æ¡ˆ2ç±»ä¼¼ï¼Œéƒ½æ˜¯è¦ä¸ºæ¯ä¸ªå•†å“ç”Ÿæˆç‹¬ç«‹é¡µé¢ï¼Œä¸åŒä¹‹å¤„åœ¨äºæ–¹æ¡ˆ2éœ€è¦æ¯æ¬¡éƒ½é‡æ–°æ¸²æŸ“ï¼Œè€Œé™æ€åŒ–ä¸éœ€è¦è¿™ä¹ˆé¢‘ç¹ã€‚ä¸è¿‡ï¼Œå…¶ä¸­è¿˜æœ‰å¾ˆå¤šç»†èŠ‚é—®é¢˜éœ€è¦è§£å†³ã€‚

æˆ‘ä»¬å¯ä»¥å…ˆå®ç°æ–¹å¼2çš„æ–¹å¼ï¼Œå†æ¥å¯¹æ¯”ä¸¤è€…åŒºåˆ«ï¼Œæ”¹é€ ä¸ºé¡µé¢é™æ€åŒ–æ–¹æ¡ˆã€‚



åä¸¤ç§æ–¹æ¡ˆéƒ½æ˜¯åœ¨æœåŠ¡ç«¯å®Œæˆé¡µé¢æ¸²æŸ“ï¼Œä»¥å‰æœåŠ¡ç«¯æ¸²æŸ“æˆ‘ä»¬éƒ½ä½¿ç”¨çš„JSPï¼Œä¸è¿‡åœ¨SpringBootä¸­å·²ç»ä¸æ¨èä½¿ç”¨Jspäº†ï¼Œå› æ­¤æˆ‘ä»¬ä¼šä½¿ç”¨å¦å¤–çš„æ¨¡æ¿å¼•æ“æŠ€æœ¯ï¼šThymeleaf

ä¸å…¶ç±»ä¼¼çš„æ¨¡æ¿æ¸²æŸ“æŠ€æœ¯æœ‰ï¼šFreemarkerã€Velocityç­‰éƒ½å¯ä»¥ã€‚

## 1.2 Thymeleafå…¥é—¨

åœ¨å•†å“è¯¦æƒ…é¡µä¸­ï¼Œæˆ‘ä»¬ä¼šä½¿ç”¨åˆ°Thymeleafæ¥æ¸²æŸ“é¡µé¢ï¼Œå¦‚æœéœ€è¦å…ˆäº†è§£Thymeleafçš„è¯­æ³•ã€‚è¯¦è§è¯¾å‰èµ„æ–™ä¸­ã€ŠThymeleafè¯­æ³•å…¥é—¨.mdã€‹



## 1.3 å•†å“è¯¦æƒ…é¡µæœåŠ¡

æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªå¾®æœåŠ¡ï¼Œç”¨æ¥å®Œæˆå•†å“è¯¦æƒ…é¡µçš„æ¸²æŸ“ã€‚

### 1.3.1 åˆ›å»ºmodule

å•†å“çš„è¯¦æƒ…é¡µæœåŠ¡ï¼Œå‘½åä¸ºï¼š`ly-page`

![1553221580631](assets/1553221580631.png)

ç›®å½•ï¼š

![1553221600298](assets/1553221600298.png) 

### 1.3.2 pomä¾èµ–

```XML
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
    <parent>
        <artifactId>leyou</artifactId>
        <groupId>com.leyou</groupId>
        <version>1.0-SNAPSHOT</version>
    </parent>
    <modelVersion>4.0.0</modelVersion>

    <artifactId>ly-page</artifactId>

    <dependencies>
        <!--eureka-->
        <dependency>
            <groupId>org.springframework.cloud</groupId>
            <artifactId>spring-cloud-starter-netflix-eureka-client</artifactId>
        </dependency>
        <!--web-->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-web</artifactId>
        </dependency>
        <!--thymeleaf-->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-thymeleaf</artifactId>
        </dependency>
        <!--feign-->
        <dependency>
            <groupId>org.springframework.cloud</groupId>
            <artifactId>spring-cloud-starter-openfeign</artifactId>
        </dependency>
        <!-- å•†å“æœåŠ¡æ¥å£ -->
        <dependency>
            <groupId>com.leyou</groupId>
            <artifactId>ly-item-interface</artifactId>
            <version>1.0-SNAPSHOT</version>
        </dependency>
        <!--å•å…ƒæµ‹è¯•-->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-test</artifactId>
        </dependency>
    </dependencies>
    <build>
        <plugins>
            <plugin>
                <groupId>org.springframework.boot</groupId>
                <artifactId>spring-boot-maven-plugin</artifactId>
            </plugin>
        </plugins>
    </build>
</project>
```

### 1.3.3 ç¼–å†™å¯åŠ¨ç±»

```java
@EnableDiscoveryClient
@EnableFeignClients
@SpringBootApplication
public class LyPageApplication {
    public static void main(String[] args) {
        SpringApplication.run(LyPageApplication.class, args);
    }
}
```

### 1.3.4 application.yml

```yaml
server:
  port: 8084
spring:
  application:
    name: page-service
    #æŠŠthymeleaf ç¼“å­˜å…³é—­
  thymeleaf:
    cache: false
eureka:
  client:
    service-url:
      defaultZone: http://127.0.0.1:10086/eureka
```



### 1.3.5 é¡µé¢æ¨¡æ¿

æˆ‘ä»¬ä»è¯¾å‰èµ„æ–™ä¸­å¤åˆ¶item.htmlæ¨¡æ¿ï¼š

 ![1535356585076](assets/1535356585076.png)

åˆ°å½“å‰é¡¹ç›®resourceç›®å½•ä¸‹çš„templateä¸­ï¼š

  ![1535356618281](assets/1535356618281.png)



## 1.4 é¡µé¢è·³è½¬

### 1.4.1 ä¿®æ”¹é¡µé¢è·³è½¬è·¯å¾„

é¦–å…ˆæˆ‘ä»¬éœ€è¦ä¿®æ”¹æœç´¢ç»“æœé¡µçš„å•†å“åœ°å€ï¼Œç›®å‰æ‰€æœ‰å•†å“çš„åœ°å€éƒ½æ˜¯ï¼šhttp://www.leyou.com/item.html

 ![1526955707685](assets/1526955707685.png)

æˆ‘ä»¬åº”è¯¥è·³è½¬åˆ°å¯¹åº”çš„å•†å“çš„è¯¦æƒ…é¡µæ‰å¯¹ã€‚

é‚£ä¹ˆé—®é¢˜æ¥äº†ï¼šå•†å“è¯¦æƒ…é¡µæ˜¯ä¸€ä¸ªSKUï¼Ÿè¿˜æ˜¯å¤šä¸ªSKUçš„é›†åˆï¼Ÿ

![1526955852490](assets/1526955852490.png)

é€šè¿‡è¯¦æƒ…é¡µçš„é¢„è§ˆï¼Œæˆ‘ä»¬çŸ¥é“å®ƒæ˜¯å¤šä¸ªSKUçš„é›†åˆï¼Œå³SPUã€‚

æ‰€ä»¥ï¼Œé¡µé¢è·³è½¬æ—¶ï¼Œæˆ‘ä»¬åº”è¯¥æºå¸¦SPUçš„idä¿¡æ¯ã€‚

ä¾‹å¦‚ï¼šhttp://www.leyou.com/item/2314123.html

è¿™é‡Œå°±é‡‡ç”¨äº†è·¯å¾„å ä½ç¬¦çš„æ–¹å¼æ¥ä¼ é€’spuçš„idï¼Œæˆ‘ä»¬æ‰“å¼€`search.html`ï¼Œä¿®æ”¹å…¶ä¸­çš„å•†å“è·¯å¾„ï¼š

 ![1526972476737](assets/1526972476737.png)

åˆ·æ–°é¡µé¢ååœ¨çœ‹ï¼š

 ![1526972581134](assets/1526972581134.png)

### 1.4.2 nginxåå‘ä»£ç†

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬è¦æŠŠè¿™ä¸ªåœ°å€æŒ‡å‘æˆ‘ä»¬åˆšåˆšåˆ›å»ºçš„æœåŠ¡ï¼š`ly-page`ï¼Œå…¶ç«¯å£ä¸º8084

æˆ‘ä»¬åœ¨nginx.confä¸­æ·»åŠ ä¸€æ®µé€»è¾‘ï¼š

```nginx
server {
	listen       80;
	server_name  www.leyou.com;
	location /item {
		proxy_pass	http://127.0.0.1:8084;
	}
	location / {
		proxy_pass   http://leyou-portal;
	}
    
}
```

æŠŠä»¥/itemå¼€å¤´çš„è¯·æ±‚ï¼Œä»£ç†åˆ°æˆ‘ä»¬çš„8084ç«¯å£

### 1.4.3 ç¼–å†™è·³è½¬controller

åœ¨`ly-page`ä¸­ç¼–å†™controllerï¼Œæ¥æ”¶è¯·æ±‚ï¼Œå¹¶è·³è½¬åˆ°å•†å“è¯¦æƒ…é¡µï¼š

```java
@Controller
public class PageController {

    /**
     * è·³è½¬åˆ°å•†å“è¯¦æƒ…é¡µ
     * @param model
     * @param id
     * @return
     */
    @GetMapping("item/{id}.html")
    public String toItemPage(Model model, @PathVariable("id")Long id){

        return "item";
    }
}
```



### 1.4.4 æµ‹è¯•

å¯åŠ¨`ly-page`ï¼Œç‚¹å‡»æœç´¢é¡µé¢å•†å“ï¼Œçœ‹æ˜¯èƒ½å¤Ÿæ­£å¸¸è·³è½¬ï¼š

![1535422129984](assets/1535422129984.png)

ç°åœ¨çœ‹åˆ°æ˜¯500ï¼Œå› ä¸ºThymeleafæ¨¡æ¿æ¸²æŸ“å¤±è´¥äº†ï¼Œç¼ºå°‘æ¨¡æ¿æ¸²æŸ“éœ€è¦çš„Modelæ•°æ®ï¼š

![1535422177254](assets/1535422177254.png)

å› æ­¤æ¥ä¸‹æ¥ï¼Œå¿…é¡»æä¾›Modelæ•°æ®ï¼Œå®Œæˆé¡µé¢æ¸²æŸ“ã€‚

## 1.5 å®Œæˆé¡µé¢æ¸²æŸ“

### 1.5.1 é¡µé¢æ•°æ®åˆ†æ

é¦–å…ˆæˆ‘ä»¬ä¸€èµ·æ¥åˆ†æä¸€ä¸‹ï¼Œåœ¨è¿™ä¸ªé¡µé¢ä¸­éœ€è¦å“ªäº›æ•°æ®ï¼Œè¿™ä¸ªå¯ä»¥æŸ¥çœ‹`item.html`ä¸­çš„Thymeleafè¯­æ³•å¾—çŸ¥ï¼Œä¾‹å¦‚æœ‰ä¸‹é¢çš„éƒ¨åˆ†ï¼š

![1553245845879](assets/1553245845879.png)

é€ä¸ªæŸ¥çœ‹ï¼Œå‘ç°éœ€è¦ä¸‹é¢çš„å˜é‡ï¼š

- categoriesï¼šå•†å“åˆ†ç±»å¯¹è±¡é›†åˆ
- brandï¼šå“ç‰Œå¯¹è±¡
- spuNameï¼šåº”è¯¥ æ˜¯spuè¡¨ä¸­çš„nameå±æ€§
- subTitleï¼šspuä¸­ çš„å‰¯æ ‡é¢˜
- detailï¼šå•†å“è¯¦æƒ…SpuDetail
- skusï¼šå•†å“spuä¸‹çš„skué›†åˆ
- specsï¼šè§„æ ¼å‚æ•°è¿™ä¸ªæ¯”è¾ƒ ç‰¹æ®Šï¼š
  - ![1553246049965](assets/1553246049965.png)
  - é€šè¿‡ä¸Šè¿°ä»£ç ï¼Œå¯ä»¥çŸ¥é“specsæ˜¯è§„æ ¼ç»„çš„é›†åˆï¼Œç»„å†…è¦åŒ…å«paramså‚æ•°ï¼Œå°±æ˜¯è¯¥ç»„ä¸‹çš„è§„æ ¼å‚æ•°çš„é›†åˆ



æˆ‘ä»¬å·²çŸ¥çš„æ¡ä»¶æ˜¯ä¼ é€’æ¥çš„spuçš„idï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦ä¸‹é¢çš„ä¸€äº›æŸ¥è¯¢æ¥å£ï¼š

- æ ¹æ®idæŸ¥è¯¢spuï¼Œæœ€å¥½åŒæ—¶æŸ¥è¯¢å‡ºspuDetailå’Œskusï¼Œè¿™æ ·æ¯”åˆ†ä¸‰æ¬¡æŸ¥è¯¢æ•ˆç‡è¾ƒé«˜ã€‚ï¼ˆæ²¡æœ‰è¿™æ ·çš„æ¥å£ï¼‰
- æ ¹æ®å“ç‰ŒidæŸ¥è¯¢å“ç‰Œï¼ˆæœ‰ï¼‰
- æ ¹æ®åˆ†ç±»idé›†åˆæŸ¥è¯¢å•†å“åˆ†ç±»é›†åˆï¼ˆæœ‰ï¼‰
- æ ¹æ®åˆ†ç±»idæŸ¥è¯¢è§„æ ¼ç»„åŠç»„å†…è§„æ ¼å‚æ•°æ²¡æœ‰è¿™æ ·çš„æ¥å£ï¼‰

å› æ­¤æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬éœ€è¦åœ¨å•†å“å¾®æœåŠ¡è¡¥å……2ä¸ªæ¥å£ã€‚

### 1.5.2 å•†å“å¾®æœåŠ¡æä¾›æ¥å£

#### æŸ¥è¯¢spuæ¥å£

ä»¥ä¸Šæ‰€éœ€æ•°æ®ä¸­ï¼ŒæŸ¥è¯¢spuçš„æ¥å£ç›®å‰è¿˜æ²¡æœ‰ï¼Œæˆ‘ä»¬éœ€è¦åœ¨å•†å“å¾®æœåŠ¡ä¸­æä¾›è¿™ä¸ªæ¥å£ï¼š

é¦–å…ˆåœ¨`ly-item-interface`ä¸­å¯¹å¤–æä¾›çš„Feignå®¢æˆ·ç«¯ï¼ˆ`ItemClient`ï¼‰ä¸­å®šä¹‰æ¥å£ï¼š

> ItemClient

```java
/**
 * æ ¹æ®spuçš„idæŸ¥è¯¢spu
 * @param id
 * @return
 */
@GetMapping("spu/{id}")
SpuDTO findSpuById(@PathVariable("id") Long id);
```

> GoodsController

```java
/**
     * æ ¹æ®spuçš„idæŸ¥è¯¢spu
     * @param id
     * @return
     */
@GetMapping("spu/{id}")
public ResponseEntity<SpuDTO> findSpuById(@PathVariable("id") Long id){
    return ResponseEntity.ok(goodsService.findSpuById(id));
}
```

> GoodsService

```java
public SpuDTO findSpuById(Long spuId) {
        TbSpu tbSpu = spuService.getById(spuId);
        if(tbSpu == null){
            throw new LyException(ExceptionEnum.GOODS_NOT_FOUND)
        }
        return BeanHelper.copyProperties(tbSpu,SpuDTO.class);
    }
```

#### æŸ¥è¯¢è§„æ ¼å‚æ•°ç»„

æˆ‘ä»¬åœ¨é¡µé¢å±•ç¤ºè§„æ ¼æ—¶ï¼Œéœ€è¦æŒ‰ç»„å±•ç¤ºï¼š

 ![1535423451465](assets/1535423451465.png)

ç»„å†…æœ‰å¤šä¸ªå‚æ•°ï¼Œä¸ºäº†æ–¹ä¾¿å±•ç¤ºã€‚æˆ‘ä»¬æä¾›ä¸€ä¸ªæ¥å£ï¼ŒæŸ¥è¯¢è§„æ ¼ç»„ï¼ŒåŒæ—¶åœ¨è§„æ ¼ç»„ä¸­æŒæœ‰ç»„å†…çš„æ‰€æœ‰å‚æ•°ã€‚

> æ‹“å±•`SpecGroupDTO`ç±»ï¼š

æˆ‘ä»¬åœ¨`SpecGroupDTO`ä¸­æ·»åŠ ä¸€ä¸ª`SpecParamDTO`çš„é›†åˆï¼Œä¿å­˜æ”¹ç»„ä¸‹æ‰€æœ‰è§„æ ¼å‚æ•°

```java
@Data
public class SpecGroupDTO {
    private Long id;

    private Long cid;

    private String name;
    
    private List<SpecParamDTO> params;
}
```

åœ¨`ly-item-interface`ä¸­å¯¹å¤–æä¾›çš„Feignå®¢æˆ·ç«¯ï¼ˆ`ItemClient`ï¼‰ä¸­å®šä¹‰æ¥å£ï¼š

> ItemClient

```java
/**
     * æŸ¥è¯¢è§„æ ¼å‚æ•°ç»„ï¼ŒåŠç»„å†…å‚æ•°
     * @param id å•†å“åˆ†ç±»id
     * @return è§„æ ¼ç»„åŠç»„å†…å‚æ•°
     */
@GetMapping("/spec/of/category")
List<SpecGroupDTO> findSpecsByCid(@RequestParam("id") Long id);
```

> SpecController

```java
/**
     * æŸ¥è¯¢è§„æ ¼å‚æ•°ç»„ï¼ŒåŠç»„å†…å‚æ•°
     * @param id å•†å“åˆ†ç±»id
     * @return è§„æ ¼ç»„åŠç»„å†…å‚æ•°
     */
@GetMapping("/of/category")
public ResponseEntity<List<SpecGroupDTO>> findSpecsByCid(@RequestParam("id") Long id){
    return ResponseEntity.ok(specService.findSpecsByCid(id));
}
```

> SpecificationService

```java
public List<SpecGroupDTO> findSpecsByCid(Long cid) {
        // æŸ¥è¯¢è§„æ ¼ç»„
        List<SpecGroupDTO> groupList = findSpecGroupByCategory(cid);
        // æŸ¥è¯¢åˆ†ç±»ä¸‹æ‰€æœ‰è§„æ ¼å‚æ•°
        List<SpecParamDTO> params = findSpecParmams(null, cid, null);
        // å°†è§„æ ¼å‚æ•°æŒ‰ç…§groupIdè¿›è¡Œåˆ†ç»„ï¼Œå¾—åˆ°æ¯ä¸ªgroupä¸‹çš„paramçš„é›†åˆ
        Map<Long, List<SpecParamDTO>> paramMap = params.stream()
                .collect(Collectors.groupingBy(SpecParamDTO::getGroupId));
        // å¡«å†™åˆ°groupä¸­
        for (SpecGroupDTO groupDTO : groupList) {
            groupDTO.setSpecParamDTOList(paramMap.get(groupDTO.getId()));
        }
        return groupList;
    }
```

åœ¨serviceä¸­ï¼Œæˆ‘ä»¬è°ƒç”¨ä¹‹å‰ç¼–å†™è¿‡çš„æ–¹æ³•ï¼ŒæŸ¥è¯¢è§„æ ¼ç»„ï¼Œå’Œè§„æ ¼å‚æ•°ï¼Œç„¶åå°è£…è¿”å›ã€‚

### 1.5.3 å®Œå–„controller

åœ¨ä¹‹å‰çš„é¡µé¢è·³è½¬controllerä¸­ï¼Œç¼ºä¹æ¨¡å‹æ•°æ®ï¼Œå¯¼è‡´é¡µé¢æ¸²æŸ“å¤±è´¥ ã€‚æˆ‘ä»¬éœ€è¦å‡†å¤‡å¥½æ•°æ®ï¼Œå­˜å…¥Modelä¸­ï¼Œä¼ é€’ç»™é¡µé¢æ¨¡æ¿ã€‚

ä¿®æ”¹controllerä»£ç ï¼š

```java
@Controller
public class PageController {
    
    @Autowired
    private PageService pageService;

    /**
     * è·³è½¬åˆ°å•†å“è¯¦æƒ…é¡µ
     * @param model
     * @param id
     * @return
     */
    @GetMapping("item/{id}.html")
    public String toItemPage(Model model, @PathVariable("id")Long id){
        // æŸ¥è¯¢æ¨¡å‹æ•°æ®
        Map<String,Object> itemData = pageService.loadItemData(id);
        // å­˜å…¥æ¨¡å‹æ•°æ®ï¼Œå› ä¸ºæ•°æ®è¾ƒå¤šï¼Œç›´æ¥å­˜å…¥ä¸€ä¸ªmap
        model.addAllAttributes(itemData);
        return "item";
    }
}
```



æ³¨æ„æˆ‘ä»¬æŠŠæ•°æ®çš„æŸ¥è¯¢å’ŒåŠ è½½æ”¾åˆ°äº†ä¸€ä¸ªPageServiceä¸­å»å®Œæˆï¼Œæ•°æ®è¾ƒå¤šï¼Œå› æ­¤è¿™é‡Œçš„PageServiceæ–¹æ³•è¿”å›çš„æ˜¯ä¸€ä¸ªMapã€‚



### 1.5.4 å°è£…Modelæ•°æ®

æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªPageServiceï¼Œåœ¨é‡Œé¢æ¥å°è£…æ•°æ®æ¨¡å‹ã€‚

> Serviceä»£ç 

```java
package com.leyou.page.service;

import com.leyou.item.client.ItemClient;
import com.leyou.item.dto.BrandDTO;
import com.leyou.item.dto.CategoryDTO;
import com.leyou.item.dto.SpecGroupDTO;
import com.leyou.item.dto.SpuDTO;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

import java.util.HashMap;
import java.util.List;
import java.util.Map;


@Service
public class PageService {

    @Autowired
    private ItemClient itemClient;

/**
     * è·å–æ¨¡æ¿é¡µé¢éœ€è¦çš„åŠ¨æ€æ•°æ®
     * @param spuId
     * @return
     */
    public Map<String, Object> loadData(Long spuId) {
        Map<String, Object> map = new HashMap<>();
//        æ ¹æ®spuid è·å–spuå¯¹è±¡
        SpuDTO spuDTO = itemClient.findSpuById(spuId);
//      categories åˆ†ç±»çš„é›†åˆ
        List<CategoryDTO> categoryDTOList = itemClient.findCategoryListByIds(spuDTO.getCategoryIds());
//      brand å“ç‰Œå¯¹è±¡
        BrandDTO brandDTO = itemClient.findBrandById(spuDTO.getBrandId());
//      detail å•†å“è¯¦æƒ…å¯¹è±¡  spu_detailçš„æ•°æ®
        SpuDetailDTO spuDetailDTO = itemClient.findSpuDetailBySpuId(spuId);
//        skus spuå¯¹åº”çš„skué›†åˆ
        List<SkuDTO> skuDTOList = itemClient.findSkuListBySpuId(spuId);
//        specs å•†å“å¯¹åº”çš„è§„æ ¼å‚æ•°ç»„ï¼Œåå­—ï¼Œå€¼
        List<SpecGroupDTO> specGroupDTOList = itemClient.findSpecGorupList(spuDTO.getCid3());
        map.put("categories",categoryDTOList);
        map.put("brand",brandDTO);
        map.put("spuName",spuDTO.getName());
        map.put("subTitle",spuDTO.getSubTitle());
        map.put("detail",spuDetailDTO);
        map.put("skus",skuDTOList);
        map.put("specs",specGroupDTOList);
        return map;
    }
```



### 1.5.5 é¡µé¢æµ‹è¯•æ•°æ®

é¡µé¢çš„æ•°æ®æ¸²æŸ“ä»£ç å·²ç»å¸®å¤§å®¶å†™å¥½äº†ï¼Œå› æ­¤å¯åŠ¨é¡¹ç›®å¯ä»¥ç›´æ¥çœ‹åˆ°æœ€ç»ˆçš„æ•ˆæœï¼š

![1535357366958](assets/1535357366958.png)



## ğŸ—ç»éªŒåˆ†äº«-æ¨¡æ¿æŠ¥é”™

### 1ã€éœ€æ±‚

> åœ¨ly-pageå·¥ç¨‹ï¼Œå¯¼å…¥å•†å“è¯¦æƒ…æ¨¡æ¿item.htmlã€‚å¹¶ç¼–å†™controllerï¼Œç¼–å†™serviceè¿œç¨‹è°ƒç”¨itemæœåŠ¡è·å–å•†å“è¯¦æƒ…ä¿¡æ¯ã€‚ä»£ç å¦‚ä¸‹ï¼š

controllerä»£ç ï¼š

```java
    /***
     * è·å–å•†å“ä¿¡æ¯
     * @param spuId
     * @param model
     * @return
     */
    @GetMapping("/item/{id}.html")
    public String loadItemData(@PathVariable(name = "id") Long spuId, Model model){
//        è·å–spuid å¯¹åº”çš„å•†å“ä¿¡æ¯
        Map<String,Object> itemData = pageService.loadData(spuId);
        //æŠŠå•†å“ä¿¡æ¯æ”¾å…¥model
        model.addAllAttributes(itemData);
        //ä½¿ç”¨item.htmlæ¨¡æ¿
        return "item";
    }
```

serviceä»£ç ï¼š

```java
 /**
     * è·å–å•†å“ä¿¡æ¯
     * @param spuId
     * @return
     */
    public Map<String, Object> loadData(Long spuId) {
//        æ ¹æ®spuid è·å–spuå¯¹è±¡
        SpuDTO spuDTO = itemClient.findSpuById(spuId);
//        è¿œç¨‹è°ƒç”¨ï¼ŒitemæœåŠ¡ï¼Œè·å–å•†å“å¯¹åº”åˆ†ç±»çš„3çº§å¯¹è±¡
        List<CategoryDTO> categoryListByIds = itemClient.findCategoryListByIds(spuDTO.getCategoryIds());
//        è·å–å“ç‰Œå¯¹è±¡
        BrandDTO brandDTO = itemClient.findBrandById(spuDTO.getBrandId());
//        æ ¹æ®spuid æŸ¥è¯¢spuDetailçš„æ•°æ®
        SpuDetailDTO spuDetailDTO = itemClient.findSpuDetailBySpuId(spuId);
//        æ ¹æ®spuid æŸ¥è¯¢skué›†åˆ
        List<SkuDTO> skuDTOList = itemClient.findSkuListBySpuId(spuId);
//        è·å–è§„æ ¼å‚æ•°ç»„å’Œç»„å†…çš„è§„æ ¼å‚æ•°
        List<SpecGroupDTO> specGroupList = itemClient.findSpecGroup(spuDTO.getCid3());

        Map<String,Object> data = new HashMap<>();
        data.put("categories",categoryListByIds);
        data.put("brand",brandDTO);
        data.put("spuName",spuDTO.getName());
        data.put("subTitle",spuDTO.getSubTitle());
        data.put("detail",spuDetailDTO);
        data.put("skus",skuDTOList);
        data.put("specs",specGroupList);
        return data;
    }
```

### 2ã€é—®é¢˜æè¿°

> ç„¶åè®¿é—®controllerï¼Œå»çœ‹é¡µé¢ï¼Œå‘ç°é¡µé¢å‡ºç°é”™è¯¯ï¼Œ**ä»·æ ¼ä¸æ˜¾ç¤ºï¼Œç‰¹æœ‰è§„æ ¼å±æ€§**

å¦‚å›¾ï¼š

![](../../../%E8%AF%BE%E7%A8%8B/%E9%A1%B9%E7%9B%AE%E4%BA%8C/%E4%B9%90%E4%BC%98%E5%95%86%E5%9F%8E-%E6%89%80%E6%9C%89%E7%AC%94%E8%AE%B0-%E5%B8%A6%E7%BB%8F%E9%AA%8C%E5%80%BC/assets/1595751022.png)



> ç„¶ååœ¨çœ‹è§„æ ¼å‚æ•°ï¼Œå‘ç°è§„æ ¼å‚æ•°ä¹Ÿä¸æ˜¾ç¤º

å¦‚å›¾ï¼š

![](../../../%E8%AF%BE%E7%A8%8B/%E9%A1%B9%E7%9B%AE%E4%BA%8C/%E4%B9%90%E4%BC%98%E5%95%86%E5%9F%8E-%E6%89%80%E6%9C%89%E7%AC%94%E8%AE%B0-%E5%B8%A6%E7%BB%8F%E9%AA%8C%E5%80%BC/assets/1595751401.png)

### 3ã€é—®é¢˜åˆ†æ

> æˆ‘ä»¬å‘ç°é¡µé¢å¯ä»¥æ˜¾ç¤ºï¼Œä½†æ˜¯ä»·æ ¼å’Œç‰¹æœ‰è§„æ ¼å±æ€§ï¼Œä»¥åŠè§„æ ¼åŒ…è£…å†…å®¹éƒ½ä¸æ˜¾ç¤ºã€‚
>
> æˆ‘ä»¬æ¥åˆ†æåŸå› ï¼š
>
> é¦–å…ˆå¦‚æœé¡µé¢å¯ä»¥æ˜¾ç¤ºï¼Œè¯´æ˜controlleræ˜¯å¯ä»¥è®¿é—®çš„ã€‚æ˜¾ç¤ºçš„é¡µé¢æ˜¯æ¨¡æ¿ï¼Œé¡µé¢èƒ½æ˜¾ç¤ºè¯´æ˜æ¨¡æ¿ä¹Ÿæ²¡é—®é¢˜ã€‚
>
> é‚£ä¹ˆæœ‰å¯èƒ½å°±æ˜¯æ•°æ®æœ‰é—®é¢˜ã€‚



> ç°åœ¨æˆ‘ä»¬æ¥çœ‹chromeæµè§ˆå™¨çš„ä¿¡æ¯ï¼Œå‘ç°æœ‰forEachçš„æŠ¥é”™

![](../../../%E8%AF%BE%E7%A8%8B/%E9%A1%B9%E7%9B%AE%E4%BA%8C/%E4%B9%90%E4%BC%98%E5%95%86%E5%9F%8E-%E6%89%80%E6%9C%89%E7%AC%94%E8%AE%B0-%E5%B8%A6%E7%BB%8F%E9%AA%8C%E5%80%BC/assets/1595752208.png)

> ç„¶åæˆ‘ä»¬ç‚¹å‡»è¿™ä¸ªé”™è¯¯ï¼Œå¯ä»¥çœ‹åˆ°åœ¨æºä»£ç çš„é”™è¯¯

![](../../../%E8%AF%BE%E7%A8%8B/%E9%A1%B9%E7%9B%AE%E4%BA%8C/%E4%B9%90%E4%BC%98%E5%95%86%E5%9F%8E-%E6%89%80%E6%9C%89%E7%AC%94%E8%AE%B0-%E5%B8%A6%E7%BB%8F%E9%AA%8C%E5%80%BC/assets/1595752310.png)

> å¯ä»¥å‘ç° group.params.forEach() è¿™ä¸ªæ–¹æ³•æŠ¥é”™äº†ï¼Œä¹Ÿå°±æ˜¯params.forEachæœ‰é”™ï¼Œparamsæ˜¯nullã€‚
>
> è¿™ä¸ªparams æ˜¯groupé‡Œé¢çš„paramsï¼Œä¹Ÿå°±æ˜¯ä»è§„æ ¼ç»„ä¸­è·å–çš„è§„æ ¼å‚æ•°ã€‚
>
> é‚£æˆ‘ä»¬å°±æ¥çœ‹çœ‹å“ªä¸ªparamsæ˜¯null
>
> æˆ‘ä»¬æ¥çœ‹const specs è¿™ä¸ªå˜é‡é‡Œé¢çš„å†…å®¹ï¼š

![](../../../%E8%AF%BE%E7%A8%8B/%E9%A1%B9%E7%9B%AE%E4%BA%8C/%E4%B9%90%E4%BC%98%E5%95%86%E5%9F%8E-%E6%89%80%E6%9C%89%E7%AC%94%E8%AE%B0-%E5%B8%A6%E7%BB%8F%E9%AA%8C%E5%80%BC/assets/1595753037.png)

> æ‰¾åˆ°é—®é¢˜äº†ï¼åŸæ¥æ˜¯ id=14 çš„specgroup å¯¹åº”çš„params å†…å®¹æ˜¯nullã€‚

### 4ã€è§£å†³é—®é¢˜

> æˆ‘ä»¬æ¥åˆ°æ•°æ®åº“ï¼ŒæŸ¥è¯¢groupid=14 çš„è§„æ ¼å±æ€§å†…å®¹ï¼Œsqlå¦‚ä¸‹ï¼š

```sql
SELECT * FROM tb_spec_param WHERE group_id=14;
```

ç»“æœå¦‚ä¸‹ï¼š

![](../../../%E8%AF%BE%E7%A8%8B/%E9%A1%B9%E7%9B%AE%E4%BA%8C/%E4%B9%90%E4%BC%98%E5%95%86%E5%9F%8E-%E6%89%80%E6%9C%89%E7%AC%94%E8%AE%B0-%E5%B8%A6%E7%BB%8F%E9%AA%8C%E5%80%BC/assets/1595753236.png)

> é—®é¢˜ç¡®å®šäº†ï¼Œå°±æ˜¯æ²¡æœ‰è·å–åˆ°è§„æ ¼å‚æ•°ï¼Œå¯¼è‡´é¡µé¢åœ¨å¤„ç†æ•°æ®çš„æ—¶å€™æŠ¥é”™äº†ã€‚ 
>
> åŸæ¥ï¼šç»„idæ˜¯14çš„è¿™æ¡æ•°æ®æ˜¯åœ¨æµ‹è¯•åå°æ·»åŠ è§„æ ¼ç»„åŠŸèƒ½æ—¶æ·»åŠ çš„æ•°æ®ï¼Œä½†æ˜¯æ²¡æœ‰ç»™ç»„ä¸‹æ·»åŠ è§„æ ¼å‚æ•°

### 5ã€éªŒè¯

> æˆ‘ä»¬æŠŠid=14çš„è§„æ ¼ç»„åˆ é™¤ï¼Œå‘ç°é¡µé¢å†…å®¹å¯ä»¥æ­£å¸¸æ˜¾ç¤ºäº†

![](assets/1595753504.png)



# 2ã€Thymeleafé¡µé¢é™æ€åŒ–

## 2.1.ç®€ä»‹

### 2.1.1.é—®é¢˜åˆ†æ

ç°åœ¨ï¼Œæˆ‘ä»¬çš„é¡µé¢æ˜¯é€šè¿‡Thymeleafæ¨¡æ¿å¼•æ“æ¸²æŸ“åè¿”å›åˆ°å®¢æˆ·ç«¯ã€‚åœ¨åå°éœ€è¦å¤§é‡çš„æ•°æ®æŸ¥è¯¢ï¼Œè€Œåæ¸²æŸ“å¾—åˆ°HTMLé¡µé¢ã€‚ä¼šå¯¹æ•°æ®åº“é€ æˆå‹åŠ›ï¼Œå¹¶ä¸”è¯·æ±‚çš„å“åº”æ—¶é—´è¿‡é•¿ï¼Œå¹¶å‘èƒ½åŠ›ä¸é«˜ã€‚

å¤§å®¶èƒ½æƒ³åˆ°ä»€ä¹ˆåŠæ³•æ¥è§£å†³è¿™ä¸ªé—®é¢˜ï¼Ÿ

- ç¼“å­˜ï¼Œåç«¯å¯ä»¥å¯¹è¦æŸ¥è¯¢çš„æ•°æ®è¿›è¡Œç¼“å­˜ï¼Œæé«˜æŸ¥è¯¢æ•ˆç‡ï¼Œå‡å°æ•°æ®åº“å‹åŠ›ã€‚
  - ä¼˜ç‚¹ï¼šä»¥åæ— è®ºæ˜¯é¡µé¢æŸ¥è¯¢æ•°æ®ã€ç§»åŠ¨çš„æŸ¥è¯¢æ•°æ®ï¼Œéƒ½èµ°ç¼“å­˜ï¼Œæ›´é€šç”¨
  - ç¼ºç‚¹ï¼šè¯·æ±‚ä¾ç„¶ä¼šåˆ°è¾¾æœåŠ¡ç«¯ï¼Œé€ æˆæœåŠ¡ç«¯å‹åŠ›ã€‚
- é™æ€åŒ–ï¼ŒæŠŠé¡µé¢æ¸²æŸ“åå†™å…¥HTMLæ–‡ä»¶ï¼Œä»¥åä¸å†æŸ¥è¯¢æœåŠ¡ç«¯æ•°æ®
  - ä¼˜ç‚¹ï¼šä¸è®¿é—®æœåŠ¡ç«¯ï¼Œæ•ˆç‡æ›´é«˜
  - ç¼ºç‚¹ï¼šé€‚åº”äºH5ï¼ŒAPPä¸­éœ€è¦å¦å¤–çš„é™æ€åŒ–æ–¹æ¡ˆ

### 2.1.2.ä»€ä¹ˆæ˜¯é™æ€åŒ–

é™æ€åŒ–æ˜¯æŒ‡æŠŠåŠ¨æ€ç”Ÿæˆçš„HTMLé¡µé¢å˜ä¸ºé™æ€å†…å®¹ä¿å­˜ï¼Œä»¥åç”¨æˆ·çš„è¯·æ±‚åˆ°æ¥ï¼Œç›´æ¥è®¿é—®é™æ€é¡µé¢ï¼Œä¸å†ç»è¿‡æœåŠ¡çš„æ¸²æŸ“ã€‚

è€Œé™æ€çš„HTMLé¡µé¢å¯ä»¥éƒ¨ç½²åœ¨nginxä¸­ï¼Œä»è€Œå¤§å¤§æé«˜å¹¶å‘èƒ½åŠ›ï¼Œå‡å°tomcatå‹åŠ›ã€‚



### 2.1.3.å¦‚ä½•å®ç°é™æ€åŒ–

ç›®å‰ï¼Œé™æ€åŒ–é¡µé¢éƒ½æ˜¯é€šè¿‡æ¨¡æ¿å¼•æ“æ¥ç”Ÿæˆï¼Œè€Œåä¿å­˜åˆ°nginxæœåŠ¡å™¨æ¥éƒ¨ç½²ã€‚å¸¸ç”¨çš„æ¨¡æ¿å¼•æ“æ¯”å¦‚ï¼š

- Freemarker
- Velocity
- Thymeleaf

æˆ‘ä»¬ä¹‹å‰å°±ä½¿ç”¨çš„Thymeleafï¼Œæ¥æ¸²æŸ“htmlè¿”å›ç»™ç”¨æˆ·ã€‚Thymeleafé™¤äº†å¯ä»¥æŠŠæ¸²æŸ“ç»“æœå†™å…¥Responseï¼Œä¹Ÿå¯ä»¥å†™åˆ°æœ¬åœ°æ–‡ä»¶ï¼Œä»è€Œå®ç°é™æ€åŒ–ã€‚

## 2.2.Thymeleafç”Ÿæˆé™æ€é¡µ

### 2.2.1.æ¦‚å¿µ

å…ˆè¯´ä¸‹Thymeleafä¸­çš„å‡ ä¸ªæ¦‚å¿µï¼š

- Contextï¼šè¿è¡Œä¸Šä¸‹æ–‡
- TemplateResolverï¼šæ¨¡æ¿è§£æå™¨
- TemplateEngineï¼šæ¨¡æ¿å¼•æ“

> Context

ä¸Šä¸‹æ–‡ï¼š ç”¨æ¥ä¿å­˜æ¨¡å‹æ•°æ®ï¼Œå½“æ¨¡æ¿å¼•æ“æ¸²æŸ“æ—¶ï¼Œå¯ä»¥ä»Contextä¸Šä¸‹æ–‡ä¸­è·å–æ•°æ®ç”¨äºæ¸²æŸ“ã€‚

å½“ä¸SpringBootç»“åˆä½¿ç”¨æ—¶ï¼Œæˆ‘ä»¬æ”¾å…¥Modelçš„æ•°æ®å°±ä¼šè¢«å¤„ç†åˆ°Contextï¼Œä½œä¸ºæ¨¡æ¿æ¸²æŸ“çš„æ•°æ®ä½¿ç”¨ã€‚

> TemplateResolver

æ¨¡æ¿è§£æå™¨ï¼šç”¨æ¥è¯»å–æ¨¡æ¿ç›¸å…³çš„é…ç½®ï¼Œä¾‹å¦‚ï¼šæ¨¡æ¿å­˜æ”¾çš„ä½ç½®ä¿¡æ¯ï¼Œæ¨¡æ¿æ–‡ä»¶åç§°ï¼Œæ¨¡æ¿æ–‡ä»¶çš„ç±»å‹ç­‰ç­‰ã€‚

å½“ä¸SpringBootç»“åˆæ—¶ï¼ŒTemplateResolverå·²ç»ç”±å…¶åˆ›å»ºå®Œæˆï¼Œå¹¶ä¸”å„ç§é…ç½®ä¹Ÿéƒ½æœ‰é»˜è®¤å€¼ï¼Œæ¯”å¦‚æ¨¡æ¿å­˜æ”¾ä½ç½®ï¼Œå…¶é»˜è®¤å€¼å°±æ˜¯ï¼štemplatesã€‚æ¯”å¦‚æ¨¡æ¿æ–‡ä»¶ç±»å‹ï¼Œå…¶é»˜è®¤å€¼å°±æ˜¯htmlã€‚

> TemplateEngine

æ¨¡æ¿å¼•æ“ï¼šç”¨æ¥è§£ææ¨¡æ¿çš„å¼•æ“ï¼Œéœ€è¦ä½¿ç”¨åˆ°ä¸Šä¸‹æ–‡ã€æ¨¡æ¿è§£æå™¨ã€‚åˆ†åˆ«ä»ä¸¤è€…ä¸­è·å–æ¨¡æ¿ä¸­éœ€è¦çš„æ•°æ®ï¼Œæ¨¡æ¿æ–‡ä»¶ã€‚ç„¶ååˆ©ç”¨å†…ç½®çš„è¯­æ³•è§„åˆ™è§£æï¼Œä»è€Œè¾“å‡ºè§£æåçš„æ–‡ä»¶ã€‚æ¥çœ‹ä¸‹æ¨¡æ¿å¼•èµ·è¿›è¡Œå¤„ç†çš„å‡½æ•°ï¼š

```java
templateEngine.process("æ¨¡æ¿å", context, writer);
```

ä¸‰ä¸ªå‚æ•°ï¼š

- æ¨¡æ¿åç§°
- ä¸Šä¸‹æ–‡ï¼šé‡Œé¢åŒ…å«æ¨¡å‹æ•°æ®
- writerï¼šè¾“å‡ºç›®çš„åœ°çš„æµ

åœ¨è¾“å‡ºæ—¶ï¼Œæˆ‘ä»¬å¯ä»¥æŒ‡å®šè¾“å‡ºçš„ç›®çš„åœ°ï¼Œå¦‚æœç›®çš„åœ°æ˜¯Responseçš„æµï¼Œé‚£å°±æ˜¯ç½‘ç»œå“åº”ã€‚å¦‚æœç›®çš„åœ°æ˜¯æœ¬åœ°æ–‡ä»¶ï¼Œé‚£å°±å®ç°é™æ€åŒ–äº†ã€‚

è€Œåœ¨SpringBootä¸­å·²ç»è‡ªåŠ¨é…ç½®äº†æ¨¡æ¿å¼•æ“ï¼Œå› æ­¤æˆ‘ä»¬ä¸éœ€è¦å…³å¿ƒè¿™ä¸ªã€‚ç°åœ¨æˆ‘ä»¬åšé™æ€åŒ–ï¼Œå°±æ˜¯æŠŠè¾“å‡ºçš„ç›®çš„åœ°æ”¹æˆæœ¬åœ°æ–‡ä»¶å³å¯ï¼

### 2.2.2.å…·ä½“å®ç°

æˆ‘ä»¬åœ¨PageServiceä¸­ï¼Œç¼–å†™æ–¹æ³•ï¼Œå®ç°é™æ€åŒ–åŠŸèƒ½ï¼š

```java
@Slf4j
@Service
public class PageService {

    @Autowired
    private ItemClient itemClient;

    @Autowired
    private SpringTemplateEngine templateEngine;

    @Value("${ly.static.itemDir}")
    private String itemDir;
    @Value("${ly.static.itemTemplate}")
    private String itemTemplate;

    /**
     * è·å–æ¨¡æ¿é¡µé¢éœ€è¦çš„åŠ¨æ€æ•°æ®
     * @param spuId
     * @return
     */
    public Map<String, Object> loadData(Long spuId) {
        Map<String, Object> map = new HashMap<>();
//        æ ¹æ®spuid è·å–spuå¯¹è±¡
        SpuDTO spuDTO = itemClient.findSpuById(spuId);
//      categories åˆ†ç±»çš„é›†åˆ
        List<CategoryDTO> categoryDTOList = itemClient.findCategoryListByIds(spuDTO.getCategoryIds());
//      brand å“ç‰Œå¯¹è±¡
        BrandDTO brandDTO = itemClient.findBrandById(spuDTO.getBrandId());
//      detail å•†å“è¯¦æƒ…å¯¹è±¡  spu_detailçš„æ•°æ®
        SpuDetailDTO spuDetailDTO = itemClient.findSpuDetailBySpuId(spuId);
//        skus spuå¯¹åº”çš„skué›†åˆ
        List<SkuDTO> skuDTOList = itemClient.findSkuListBySpuId(spuId);
//        specs å•†å“å¯¹åº”çš„è§„æ ¼å‚æ•°ç»„ï¼Œåå­—ï¼Œå€¼
        List<SpecGroupDTO> specGroupDTOList = itemClient.findSpecGorupList(spuDTO.getCid3());
        map.put("categories",categoryDTOList);
        map.put("brand",brandDTO);
        map.put("spuName",spuDTO.getName());
        map.put("subTitle",spuDTO.getSubTitle());
        map.put("detail",spuDetailDTO);
        map.put("skus",skuDTOList);
        map.put("specs",specGroupDTOList);
        return map;
    }

    public void createItemHtml(Long id) {
        // ä¸Šä¸‹æ–‡ï¼Œå‡†å¤‡æ¨¡å‹æ•°æ®
        Context context = new Context();
        // è°ƒç”¨ä¹‹å‰å†™å¥½çš„åŠ è½½æ•°æ®æ–¹æ³•
        context.setVariables(loadItemData(id));
        // å‡†å¤‡æ–‡ä»¶è·¯å¾„
        File dir = new File(itemDir);
        if (!dir.exists()) {
            if (!dir.mkdirs()) {
                // åˆ›å»ºå¤±è´¥ï¼ŒæŠ›å‡ºå¼‚å¸¸
                log.error("ã€é™æ€é¡µæœåŠ¡ã€‘åˆ›å»ºé™æ€é¡µç›®å½•å¤±è´¥ï¼Œç›®å½•åœ°å€ï¼š{}", dir.getAbsolutePath());
                throw new LyException(ExceptionEnum.DIRECTORY_WRITER_ERROR);
            }
        }
        File filePath = new File(dir, id + ".html");
        // å‡†å¤‡è¾“å‡ºæµ
        try (PrintWriter writer = new PrintWriter(filePath, "UTF-8")) {
            templateEngine.process(itemTemplate, context, writer);
        } catch (IOException e) {
            log.error("ã€é™æ€é¡µæœåŠ¡ã€‘é™æ€é¡µç”Ÿæˆå¤±è´¥ï¼Œå•†å“idï¼š{}", id, e);
            throw new LyException(ExceptionEnum.FILE_WRITER_ERROR);
        }
    }
}
```

åœ¨application.ymlä¸­é…ç½®ç”Ÿæˆé™æ€æ–‡ä»¶çš„ç›®å½•ï¼š

```yaml
ly:
  static:
    itemDir: C:\\develop\\nginx-1.12.2\\html\\item
    itemTemplate: item
```



### 2.2.4.å•å…ƒæµ‹è¯•ï¼š

æˆ‘ä»¬ç¼–å†™ä¸€ä¸ªå•å…ƒæµ‹è¯•ï¼š

```java
package com.leyou.page.test;

import com.leyou.page.service.PageService;
import org.junit.Test;
import org.junit.runner.RunWith;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.SpringApplicationRunListener;
import org.springframework.boot.test.context.SpringBootTest;
import org.springframework.test.context.junit4.SpringRunner;

import java.util.Arrays;
import java.util.List;

@SpringBootTest
@RunWith(SpringRunner.class)
public class TestCreatePage {

    @Autowired
    private PageService pageService;
    @Test
    public void testCreateHtml(){
        List<Long> spuIdList = Arrays.asList(2L, 3L, 4L, 5L, 6L, 7L, 8L, 9L);
        for (Long spuId : spuIdList) {
            pageService.createHtml(spuId);
        }

    }
}

```

ç„¶ååˆ°nginxä¸‹æŸ¥çœ‹ï¼š

![1575341879825](assets/1575341879825.png)





## 2.3.nginxä»£ç†é™æ€é¡µé¢

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬ä¿®æ”¹nginxï¼Œè®©å®ƒå¯¹å•†å“è¯·æ±‚è¿›è¡Œç›‘å¬ï¼ŒæŒ‡å‘æœ¬åœ°é™æ€é¡µé¢ï¼Œå¦‚æœæœ¬åœ°æ²¡æ‰¾åˆ°ï¼Œæ‰è¿›è¡Œåå‘ä»£ç†ï¼š

```nginx
server {
	listen       80;
	server_name  www.leyou.com;
	location /item {
		# å…ˆæ‰¾æœ¬åœ°
        root html;
        if (!-f $request_filename) { #è¯·æ±‚çš„æ–‡ä»¶ä¸å­˜åœ¨ï¼Œå°±åå‘ä»£ç†
            proxy_pass http://127.0.0.1:8084;
            break;
        }
	}
	location / {
		proxy_pass   http://leyou-portal;
	}
}
```

é‡å¯æµ‹è¯•ï¼š

å‘ç°è¯·æ±‚é€Ÿåº¦å¾—åˆ°äº†æå¤§æå‡ï¼š

![1553252883092](assets/1553252883092.png)



**`æ³¨æ„ï¼ï¼ï¼`**ï¼Œè¿™é‡Œä¸ºäº†æ¼”ç¤ºæ–¹ä¾¿æˆ‘ä»¬é‡‡ç”¨äº†ifåˆ¤æ–­æ–‡ä»¶æ˜¯å¦å­˜åœ¨ï¼Œä¸å­˜åœ¨åˆ™åå‘ä»£ç†åˆ°æœåŠ¡ç«¯ï¼ŒæœåŠ¡ç«¯ç”Ÿæˆé¡µé¢è¿”å›ã€‚è¿™ç§åšæ³•æœ‰`ç¼“å­˜ç©¿é€`çš„é£é™©ï¼Œå»ºè®®ä¸è¦åŠ å…¥ifåˆ¤æ–­ï¼Œå¦‚æœnginxä¸­ä¸å­˜åœ¨å•†å“çš„é™æ€é¡µï¼Œç›´æ¥è¿”å›404å³å¯ã€‚

å³ï¼š

```nginx
server {
	listen       80;
	server_name  www.leyou.com;
	location /item {
        root html;
	}
	location / {
		proxy_pass   http://leyou-portal;
	}
}
```



## 2.4.é™æ€åŒ–çš„æ•°æ®åŒæ­¥é—®é¢˜

æˆ‘ä»¬æ€è€ƒè¿™æ ·å‡ ä¸ªé—®é¢˜ï¼š

- å•†å“è¯¦æƒ…é¡µåº”è¯¥åœ¨ä»€ä¹ˆæ—¶å€™ç”Ÿæˆå‘¢ï¼Ÿä¸èƒ½æ¯æ¬¡éƒ½ç”¨å•å…ƒæµ‹è¯•ç”Ÿæˆå§ï¼Ÿ
- å¦‚æœå•†å“æ•°æ®ä¿®æ”¹ä»¥åï¼Œé™æ€é¡µçš„å†…å®¹ä¸å•†å“å®é™…å†…å®¹ä¸ç¬¦ï¼Œè¯¥å¦‚ä½•å®ŒæˆåŒæ­¥ï¼Ÿ
- å•†å“ä¸‹æ¶åï¼Œä¸åº”è¯¥å†å±•ç¤ºå•†å“é¡µé¢ï¼Œé™æ€é¡µå¦‚ä½•å¤„ç†ï¼Ÿ



æ€è€ƒä¸Šé¢é—®é¢˜çš„åŒæ—¶ï¼Œæˆ‘ä»¬ä¼šæƒ³èµ·ä¸€ä»¶äº‹æƒ…ï¼Œå…¶å®å•†å“æ•°æ®å¦‚æœå‘ç”Ÿäº†å¢ã€åˆ ã€æ”¹ï¼Œä¸ä»…ä»…é™æ€é¡µé¢éœ€è¦å¤„ç†ï¼Œæˆ‘ä»¬çš„ç´¢å¼•åº“æ•°æ®ä¹Ÿéœ€è¦åŒæ­¥ï¼ï¼è¿™åˆè¯¥å¦‚ä½•è§£å†³ï¼Ÿ



å› ä¸ºå•†å“æ–°å¢åéœ€è¦ä¸Šæ¶ç”¨æˆ·æ‰èƒ½çœ‹åˆ°ï¼Œå•†å“ä¿®æ”¹éœ€è¦å…ˆä¸‹æ¶ï¼Œç„¶åä¿®æ”¹ï¼Œå†ä¸Šæ¶ã€‚å› æ­¤ä¸Šè¿°é—®é¢˜å¯ä»¥ç»Ÿä¸€çš„è®¾è®¡æˆè¿™æ ·çš„é€»è¾‘å¤„ç†ï¼š

- å•†å“ä¸Šæ¶ï¼š
  - ç”Ÿæˆé™æ€é¡µ
  - æ–°å¢ç´¢å¼•åº“æ•°æ®
- å•†å“ä¸‹æ¶ï¼š
  - åˆ é™¤é™æ€é¡µï¼Œæˆ–è€…ä¿®æ”¹é™æ€é¡µ
  - åˆ é™¤ç´¢å¼•åº“æ•°æ®

è¿™æ ·æ—¢å¯ä¿è¯æ•°æ®åº“å•†å“ä¸ç´¢å¼•åº“ã€é™æ€é¡µä¸‰è€…ä¹‹é—´çš„æ•°æ®åŒæ­¥ã€‚

é‚£ä¹ˆï¼Œå¦‚ä½•å®ç°ä¸Šè¿°é€»è¾‘å‘¢ï¼Ÿ

**ç»“è®º**ï¼šæœ€å¥½ä¸è¦ä½¿ç”¨ åŒæ­¥è°ƒç”¨ï¼Œæœ€å¥½ä½¿ç”¨**å¼‚æ­¥è°ƒç”¨**

# 3ã€RocketMQæ¦‚å¿µä¸å®‰è£…

### äº†è§£RocketMQæ¦‚å¿µ

### 3.1 æ¶ˆæ¯ä¸­é—´ä»¶

æ¶ˆæ¯ä¸­é—´ä»¶åˆ©ç”¨é«˜æ•ˆå¯é çš„æ¶ˆæ¯ä¼ é€’æœºåˆ¶è¿›è¡Œå¹³å°æ— å…³çš„æ•°æ®äº¤æµï¼Œå¹¶åŸºäºæ•°æ®é€šä¿¡æ¥è¿›è¡Œ[åˆ†å¸ƒå¼ç³»ç»Ÿ](https://baike.baidu.com/item/%E5%88%86%E5%B8%83%E5%BC%8F%E7%B3%BB%E7%BB%9F)çš„é›†æˆã€‚é€šè¿‡æä¾›æ¶ˆæ¯ä¼ é€’å’Œæ¶ˆæ¯æ’é˜Ÿæ¨¡å‹ï¼Œå®ƒå¯ä»¥åœ¨åˆ†å¸ƒå¼ç¯å¢ƒä¸‹æ‰©å±•è¿›ç¨‹é—´çš„é€šä¿¡ã€‚å¯¹äºæ¶ˆæ¯ä¸­é—´ä»¶ï¼Œå¸¸è§çš„è§’è‰²å¤§è‡´ä¹Ÿå°±æœ‰Producerï¼ˆç”Ÿäº§è€…ï¼‰ã€Consumerï¼ˆæ¶ˆè´¹è€…ï¼‰

å¸¸è§çš„æ¶ˆæ¯ä¸­é—´ä»¶äº§å“:

#### 1)RocketMQ

é˜¿é‡Œç³»ä¸‹å¼€æºçš„ä¸€æ¬¾åˆ†å¸ƒå¼ã€é˜Ÿåˆ—æ¨¡å‹çš„æ¶ˆæ¯ä¸­é—´ä»¶ï¼ŒåŸåMetaqï¼Œ3.0ç‰ˆæœ¬åç§°æ”¹ä¸ºRocketMQï¼Œæ˜¯é˜¿é‡Œå‚ç…§kafkaè®¾è®¡æ€æƒ³ä½¿ç”¨javaå®ç°çš„ä¸€å¥—mqã€‚åŒæ—¶å°†é˜¿é‡Œç³»å†…éƒ¨å¤šæ¬¾mqäº§å“ï¼ˆNotifyã€metaqï¼‰è¿›è¡Œæ•´åˆï¼Œåªç»´æŠ¤æ ¸å¿ƒåŠŸèƒ½ï¼Œå»é™¤äº†æ‰€æœ‰å…¶ä»–è¿è¡Œæ—¶ä¾èµ–ï¼Œä¿è¯æ ¸å¿ƒåŠŸèƒ½æœ€ç®€åŒ–ï¼Œåœ¨æ­¤åŸºç¡€ä¸Šé…åˆé˜¿é‡Œä¸Šè¿°å…¶ä»–å¼€æºäº§å“å®ç°ä¸åŒåœºæ™¯ä¸‹mqçš„æ¶æ„ï¼Œç›®å‰ä¸»è¦å¤šç”¨äºè®¢å•äº¤æ˜“ç³»ç»Ÿã€‚

å…·æœ‰ä»¥ä¸‹ç‰¹ç‚¹ï¼š

- èƒ½å¤Ÿä¿è¯ä¸¥æ ¼çš„æ¶ˆæ¯é¡ºåº
- æä¾›é’ˆå¯¹æ¶ˆæ¯çš„è¿‡æ»¤åŠŸèƒ½
- æä¾›ä¸°å¯Œçš„æ¶ˆæ¯æ‹‰å–æ¨¡å¼
- é«˜æ•ˆçš„è®¢é˜…è€…æ°´å¹³æ‰©å±•èƒ½åŠ›
- å®æ—¶çš„æ¶ˆæ¯è®¢é˜…æœºåˆ¶
- äº¿çº§æ¶ˆæ¯å †ç§¯èƒ½åŠ›

#### 2)ActiveMQ

ActiveMQ æ˜¯Apacheå‡ºå“ï¼Œæœ€æµè¡Œçš„ï¼Œèƒ½åŠ›å¼ºåŠ²çš„å¼€æºæ¶ˆæ¯æ€»çº¿ã€‚ActiveMQ æ˜¯ä¸€ä¸ªå®Œå…¨æ”¯æŒJMS1.1å’ŒJ2EE 1.4è§„èŒƒçš„ JMS Providerå®ç°ã€‚

#### 3)RabbitMQ

AMQPåè®®çš„é¢†å¯¼å®ç°ï¼Œæ”¯æŒå¤šç§åœºæ™¯ã€‚

äº¤æ¢æœºã€é˜Ÿåˆ—   

#### 4)ZeroMQ

å²ä¸Šæœ€å¿«çš„æ¶ˆæ¯é˜Ÿåˆ—ç³»ç»Ÿï¼Œéƒ¨åˆ†åŠŸèƒ½éœ€è¦ç¼–ç å®ç°

#### 5)Kafka

Apacheä¸‹çš„ä¸€ä¸ªå­é¡¹ç›® ã€‚ç‰¹ç‚¹ï¼šé«˜ååï¼Œåœ¨ä¸€å°æ™®é€šçš„æœåŠ¡å™¨ä¸Šæ—¢å¯ä»¥è¾¾åˆ°10W/sçš„ååé€Ÿç‡ï¼›å®Œå…¨çš„åˆ†å¸ƒå¼ç³»ç»Ÿã€‚é€‚åˆå¤„ç†æµ·é‡æ•°æ®ã€‚

æ³¨æ„ï¼šåœ¨ä¹ä¼˜å•†åŸä¸­ï¼Œæˆ‘ä»¬é€šè¿‡å¼•å…¥æ¶ˆæ¯ä¸­é—´ä»¶RocketMQï¼Œä¿è¯æ•°æ®åº“å•†å“ä¸ç´¢å¼•åº“ã€é™æ€é¡µä¸‰è€…ä¹‹é—´çš„æ•°æ®åŒæ­¥ï¼Œå®ç°ä¸šåŠ¡çš„è§£è€¦åˆã€‚

### 3.2 RocketMQæ¦‚å¿µä»‹ç»

#### 3.2.1 RocketMQæ¶æ„

RocketMQä½œä¸ºä¸€æ¬¾çº¯javaã€åˆ†å¸ƒå¼ã€é˜Ÿåˆ—æ¨¡å‹çš„å¼€æºæ¶ˆæ¯ä¸­é—´ä»¶ï¼Œæ”¯æŒäº‹åŠ¡æ¶ˆæ¯ã€é¡ºåºæ¶ˆæ¯ã€æ‰¹é‡æ¶ˆæ¯ã€å®šæ—¶æ¶ˆæ¯ã€æ¶ˆæ¯å›æº¯ç­‰ã€‚RocketMQç”±é˜¿é‡Œå·´å·´å¼€æºã€‚

![1548877889288](assets/1548877889288.png)

å¦‚å›¾æ‰€ç¤ºä¸ºRocketMQåŸºæœ¬çš„éƒ¨ç½²ç»“æ„ï¼Œä¸»è¦åˆ†ä¸ºNameServeré›†ç¾¤ã€Brokeré›†ç¾¤ã€Produceré›†ç¾¤å’ŒConsumeré›†ç¾¤å››ä¸ªéƒ¨åˆ†ã€‚ 

**å¤§è‡´æµç¨‹**ï¼š
Brokeråœ¨å¯åŠ¨çš„æ—¶å€™ä¼šå»å‘NameServeræ³¨å†Œå¹¶ä¸”å®šæ—¶å‘é€å¿ƒè·³ï¼ŒProduceråœ¨å¯åŠ¨çš„æ—¶å€™ä¼šåˆ°NameServerä¸Šå»æ‹‰å–Topicæ‰€å±çš„Brokerå…·ä½“åœ°å€ï¼Œç„¶åå‘å…·ä½“çš„Brokerå‘é€æ¶ˆæ¯

ä¸ºäº†æ¶ˆé™¤å•ç‚¹æ•…éšœï¼Œå¢åŠ å¯é æ€§æˆ–å¢å¤§ååé‡ï¼Œå¯ä»¥åœ¨å¤šå°æœºå™¨ä¸Šéƒ¨ç½²å¤šä¸ªnameserverå’Œbrokerï¼Œå¹¶ä¸”ä¸ºæ¯ä¸ªbrokeréƒ¨ç½²1ä¸ªæˆ–å¤šä¸ªslave

#### 3.2.2  NameServer

NameServerçš„ä½œç”¨æ˜¯Brokerçš„æ³¨å†Œä¸­å¿ƒã€‚

**æ¯ä¸ªNameServerèŠ‚ç‚¹äº’ç›¸ä¹‹é—´æ˜¯ç‹¬ç«‹çš„ï¼Œæ²¡æœ‰ä»»ä½•ä¿¡æ¯äº¤äº’**ï¼Œä¹Ÿå°±ä¸å­˜åœ¨ä»»ä½•çš„é€‰ä¸»æˆ–è€…ä¸»ä»åˆ‡æ¢ä¹‹ç±»çš„é—®é¢˜ï¼Œå› æ­¤NameServeræ˜¯å¾ˆè½»é‡çº§çš„ã€‚å•ä¸ªNameServerèŠ‚ç‚¹ä¸­å­˜å‚¨äº†æ´»è·ƒçš„Brokeråˆ—è¡¨ï¼ˆåŒ…æ‹¬masterå’Œslaveï¼‰ï¼Œè¿™é‡Œæ´»è·ƒçš„å®šä¹‰æ˜¯ä¸NameServerä¿æŒæœ‰å¿ƒè·³ã€‚

#### 3.2.3 Topicã€Tagã€Queueã€GroupName

Topic ä¸ Tag éƒ½æ˜¯ä¸šåŠ¡ä¸Šç”¨æ¥å½’ç±»çš„æ ‡è¯†ï¼ŒåŒºåˆ†åœ¨äº Topic æ˜¯ä¸€çº§åˆ†ç±»ï¼Œè€Œ Tag å¯ä»¥ç†è§£ä¸ºæ˜¯äºŒçº§åˆ†ç±»

##### 1)Topic

æ˜¯ç”Ÿäº§è€…åœ¨å‘é€æ¶ˆæ¯å’Œæ¶ˆè´¹è€…åœ¨æ‹‰å–æ¶ˆæ¯çš„ç±»åˆ«ã€‚Topicä¸ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…ä¹‹é—´çš„å…³ç³»éå¸¸æ¾æ•£ã€‚ä¸€ä¸ªç”Ÿäº§è€…å¯ä»¥å‘é€ä¸åŒç±»å‹Topicçš„æ¶ˆæ¯ã€‚æ¶ˆè´¹è€…ç»„å¯ä»¥è®¢é˜…ä¸€ä¸ªæˆ–å¤šä¸ªä¸»é¢˜ï¼Œåªè¦è¯¥ç»„çš„å®ä¾‹ä¿æŒå…¶è®¢é˜…ä¸€è‡´å³å¯ã€‚

â€‹    Topicç¿»è¯‘ä¸º**è¯é¢˜**ã€‚æˆ‘ä»¬å¯ä»¥ç†è§£ä¸ºç¬¬ä¸€çº§æ¶ˆæ¯ç±»å‹ï¼Œæ¯”å¦‚ä¸€ä¸ªç”µå•†ç³»ç»Ÿçš„æ¶ˆæ¯å¯ä»¥åˆ†ä¸ºï¼šäº¤æ˜“æ¶ˆæ¯ã€ç‰©æµæ¶ˆæ¯ç­‰ï¼Œä¸€æ¡æ¶ˆæ¯å¿…é¡»æœ‰ä¸€ä¸ªTopicã€‚

##### 2)Tag

æ ‡ç­¾ï¼Œæ„æ€å°±æ˜¯å­ä¸»é¢˜ï¼Œä¸ºç”¨æˆ·æä¾›äº†é¢å¤–çš„çµæ´»æ€§ã€‚æœ‰äº†æ ‡ç­¾ï¼Œæ–¹ä¾¿RocketMQæä¾›çš„æŸ¥è¯¢åŠŸèƒ½ã€‚

å¯ä»¥ç†è§£ä¸ºç¬¬äºŒçº§æ¶ˆæ¯ç±»å‹ï¼Œäº¤æ˜“åˆ›å»ºæ¶ˆæ¯ï¼Œäº¤æ˜“å®Œæˆæ¶ˆæ¯..... ä¸€æ¡æ¶ˆæ¯å¯ä»¥æ²¡æœ‰Tag

##### 3)Queue

ä¸€ä¸ªtopicä¸‹ï¼Œå¯ä»¥è®¾ç½®å¤šä¸ªqueue(æ¶ˆæ¯é˜Ÿåˆ—)ï¼Œé»˜è®¤4ä¸ªé˜Ÿåˆ—ã€‚å½“æˆ‘ä»¬å‘é€æ¶ˆæ¯æ—¶ï¼Œéœ€è¦è¦æŒ‡å®šè¯¥æ¶ˆæ¯çš„topicã€‚

RocketMQä¼šè½®è¯¢è¯¥topicä¸‹çš„æ‰€æœ‰é˜Ÿåˆ—ï¼Œå°†æ¶ˆæ¯å‘é€å‡ºå»ã€‚

åœ¨ RocketMQ ä¸­ï¼Œæ‰€æœ‰æ¶ˆæ¯é˜Ÿåˆ—éƒ½æ˜¯æŒä¹…åŒ–ï¼Œé•¿åº¦æ— é™çš„æ•°æ®ç»“æ„ï¼Œæ‰€è°“é•¿åº¦æ— é™æ˜¯æŒ‡é˜Ÿåˆ—ä¸­çš„æ¯ä¸ªå­˜å‚¨å•å…ƒéƒ½æ˜¯å®šé•¿ï¼Œè®¿é—®å…¶ä¸­çš„å­˜å‚¨å•å…ƒä½¿ç”¨ Offset æ¥è®¿é—®ï¼Œoffset ä¸º java long ç±»å‹ï¼Œ64 ä½ï¼Œç†è®ºä¸Šåœ¨ 100å¹´å†…ä¸ä¼šæº¢å‡ºï¼Œæ‰€ä»¥è®¤ä¸ºæ˜¯é•¿åº¦æ— é™ã€‚

ä¹Ÿå¯ä»¥è®¤ä¸º Message Queue æ˜¯ä¸€ä¸ªé•¿åº¦æ— é™çš„æ•°ç»„ï¼ŒOffset å°±æ˜¯ä¸‹æ ‡ã€‚

##### 4)groupName

RocketMQä¸­ä¹Ÿæœ‰ç»„çš„æ¦‚å¿µã€‚ä»£è¡¨å…·æœ‰ç›¸åŒè§’è‰²çš„ç”Ÿäº§è€…ç»„åˆæˆ–æ¶ˆè´¹è€…ç»„åˆï¼Œç§°ä¸ºç”Ÿäº§è€…ç»„æˆ–æ¶ˆè´¹è€…ç»„ã€‚

ä½œç”¨æ˜¯åœ¨é›†ç¾¤HAçš„æƒ…å†µä¸‹ï¼Œä¸€ä¸ªç”Ÿäº§è€…downä¹‹åï¼Œæœ¬åœ°äº‹åŠ¡å›æ»šåï¼Œå¯ä»¥ç»§ç»­è”ç³»è¯¥ç»„ä¸‹çš„å¦å¤–ä¸€ä¸ªç”Ÿäº§è€…å®ä¾‹ï¼Œä¸è‡³äºå¯¼è‡´ä¸šåŠ¡èµ°ä¸ä¸‹å»ã€‚åœ¨æ¶ˆè´¹è€…ç»„ä¸­ï¼Œå¯ä»¥å®ç°æ¶ˆæ¯æ¶ˆè´¹çš„è´Ÿè½½å‡è¡¡å’Œæ¶ˆæ¯å®¹é”™ç›®æ ‡ã€‚

æœ‰äº†GroupNameï¼Œåœ¨é›†ç¾¤ä¸‹ï¼ŒåŠ¨æ€æ‰©å±•å®¹é‡å¾ˆæ–¹ä¾¿ã€‚åªéœ€è¦åœ¨æ–°åŠ çš„æœºå™¨ä¸­ï¼Œé…ç½®ç›¸åŒçš„GroupNameã€‚å¯åŠ¨åï¼Œå°±ç«‹å³èƒ½åŠ å…¥åˆ°æ‰€åœ¨çš„ç¾¤ç»„ä¸­ï¼Œå‚ä¸æ¶ˆæ¯ç”Ÿäº§æˆ–æ¶ˆè´¹ã€‚

#### 3.2.4 Broker-å­˜æ”¾æ¶ˆæ¯

Brokeræ˜¯å…·ä½“æä¾›ä¸šåŠ¡çš„æœåŠ¡å™¨ï¼Œå•ä¸ªBrokerèŠ‚ç‚¹ä¸æ‰€æœ‰çš„NameServerèŠ‚ç‚¹ä¿æŒé•¿è¿æ¥åŠå¿ƒè·³ï¼Œå®šæ—¶(æ¯éš”30s)æ³¨å†ŒTopicä¿¡æ¯åˆ°æ‰€æœ‰Name Serverã€‚Name Serverå®šæ—¶(æ¯éš”10s)æ‰«ææ‰€æœ‰å­˜æ´»brokerçš„è¿æ¥ï¼Œå¦‚æœName Serverè¶…è¿‡2åˆ†é’Ÿæ²¡æœ‰æ”¶åˆ°å¿ƒè·³ï¼Œåˆ™Name Serveræ–­å¼€ä¸Brokerçš„è¿æ¥ã€‚åº•å±‚çš„é€šä¿¡å’Œè¿æ¥éƒ½æ˜¯åŸºäºNettyå®ç°çš„ã€‚

è´Ÿè½½å‡è¡¡ï¼šBrokerä¸Šå­˜Topicä¿¡æ¯ï¼ŒTopicç”±å¤šä¸ªé˜Ÿåˆ—ç»„æˆï¼Œé˜Ÿåˆ—ä¼šå¹³å‡åˆ†æ•£åœ¨å¤šä¸ªBrokerä¸Šï¼Œä¼šè‡ªåŠ¨è½®è¯¢å½“å‰æ‰€æœ‰å¯å‘é€çš„broker ï¼Œå°½é‡å¹³å‡åˆ†å¸ƒåˆ°æ‰€æœ‰é˜Ÿåˆ—ä¸­ï¼Œæœ€ç»ˆæ•ˆæœå°±æ˜¯æ‰€æœ‰æ¶ˆæ¯éƒ½å¹³å‡è½åœ¨æ¯ä¸ªBrokerä¸Š

é«˜å¯ç”¨ï¼šBrokerä¸­åˆ†**master**å’Œ**slave**ä¸¤ç§è§’è‰²ï¼Œæ¯ä¸ªmasterå¯ä»¥å¯¹åº”å¤šä¸ªslaveï¼Œä½†ä¸€ä¸ªslaveåªèƒ½å¯¹åº”ä¸€ä¸ªmasterï¼Œmasterå’Œslaveé€šè¿‡æŒ‡å®šç›¸åŒçš„Brokernameç»„æˆï¼Œå…¶ä¸­ä¸åŒçš„BrokerId==0 æ˜¯masterï¼Œé0æ˜¯slaveã€‚

é«˜å¯é å¹¶å‘è¯»å†™æœåŠ¡ï¼šmasterå’Œslaveä¹‹é—´çš„åŒæ­¥æ–¹å¼åˆ†ä¸ºåŒæ­¥åŒå†™å’Œå¼‚æ­¥å¤åˆ¶ï¼Œå¼‚æ­¥å¤åˆ¶æ–¹å¼masterå’Œslaveä¹‹é—´è™½ç„¶ä¼šå­˜åœ¨å°‘é‡çš„å»¶è¿Ÿï¼Œä½†æ€§èƒ½è¾ƒåŒæ­¥åŒå†™æ–¹å¼è¦é«˜å‡º10%å·¦å³ã€‚

Topicã€Brokerã€queue

![](assets/13433554456.png)

#### 3.2.5 Producer-ç”Ÿäº§æ¶ˆæ¯

##### 3.2.5.1 ä¸nameserverçš„å…³ç³»

å•ä¸ªProducerå’Œä¸€å°NameServerèŠ‚ç‚¹(éšæœºé€‰æ‹©)ä¿æŒé•¿è¿æ¥ï¼Œå®šæ—¶æŸ¥è¯¢topicé…ç½®ä¿¡æ¯ï¼Œå¦‚æœè¯¥NameServeræŒ‚æ‰ï¼Œç”Ÿäº§è€…ä¼šè‡ªåŠ¨è¿æ¥ä¸‹ä¸€ä¸ªNameServerï¼Œç›´åˆ°æœ‰å¯ç”¨è¿æ¥ä¸ºæ­¢ï¼Œå¹¶èƒ½è‡ªåŠ¨é‡è¿ã€‚ä¸NameServerä¹‹é—´æ²¡æœ‰å¿ƒè·³ã€‚

##### 3.2.5.2 ä¸brokerçš„å…³ç³»

å•ä¸ªProducerå’Œä¸å…¶å…³è”çš„æ‰€æœ‰brokerä¿æŒé•¿è¿æ¥ï¼Œå¹¶ç»´æŒå¿ƒè·³ã€‚é»˜è®¤æƒ…å†µä¸‹æ¶ˆæ¯å‘é€é‡‡ç”¨è½®è¯¢æ–¹å¼ï¼Œä¼šå‡åŒ€å‘åˆ°å¯¹åº”Topicçš„æ‰€æœ‰queueä¸­ã€‚



#### 3.2.6 Consumer-æ¶ˆè´¹æ¶ˆæ¯

##### 3.2.6.1 ä¸nameserverçš„å…³ç³»

å•ä¸ªConsumerå’Œä¸€å°NameServerä¿æŒ**é•¿è¿æ¥**ï¼Œå®šæ—¶æŸ¥è¯¢topicé…ç½®ä¿¡æ¯ï¼Œå¦‚æœè¯¥NameServeræŒ‚æ‰ï¼Œæ¶ˆè´¹è€…ä¼šè‡ªåŠ¨è¿æ¥ä¸‹ä¸€ä¸ªNameServerï¼Œç›´åˆ°æœ‰å¯ç”¨è¿æ¥ä¸ºæ­¢ï¼Œå¹¶èƒ½è‡ªåŠ¨é‡è¿ã€‚ä¸NameServerä¹‹é—´æ²¡æœ‰å¿ƒè·³ã€‚

##### 3.2.6.2 ä¸brokerçš„å…³ç³»

å•ä¸ªConsumerå’Œä¸å…¶å…³è”çš„æ‰€æœ‰brokerä¿æŒ**é•¿è¿æ¥**ï¼Œå¹¶ç»´æŒå¿ƒè·³ï¼Œå¤±å»å¿ƒè·³åï¼Œåˆ™å…³é—­è¿æ¥ï¼Œå¹¶å‘è¯¥æ¶ˆè´¹è€…åˆ†ç»„çš„æ‰€æœ‰æ¶ˆè´¹è€…å‘å‡ºé€šçŸ¥ï¼Œåˆ†ç»„å†…æ¶ˆè´¹è€…é‡æ–°åˆ†é…é˜Ÿåˆ—ç»§ç»­æ¶ˆè´¹ã€‚

##### 3.2.6.3 æ¶ˆè´¹è€…ç±»å‹

###### 3.2.6.3.1 pull consume

Consumer çš„ä¸€ç§ï¼Œåº”ç”¨é€šå¸¸é€šè¿‡ Consumer å¯¹è±¡æ³¨å†Œä¸€ä¸ª Listener æ¥å£ï¼Œä¸€æ—¦æ”¶åˆ°æ¶ˆæ¯ï¼ŒConsumer å¯¹è±¡ç«‹åˆ»å›è°ƒ Listener æ¥å£æ–¹æ³•ï¼Œç±»ä¼¼äºactivemqçš„æ–¹å¼

###### 3.2.6.3.2 push consume

Consumer çš„ä¸€ç§ï¼Œåº”ç”¨é€šå¸¸ä¸»åŠ¨è°ƒç”¨ Consumer çš„æ‹‰æ¶ˆæ¯æ–¹æ³•ä» Broker æ‹‰æ¶ˆæ¯ï¼Œä¸»åŠ¨æƒç”±åº”ç”¨æ§åˆ¶

#### 3.2.7 æ¶ˆè´¹æ¨¡å¼

##### 3.2.7.1 é›†ç¾¤æ¨¡å¼

åœ¨é»˜è®¤æƒ…å†µä¸‹ï¼Œå°±æ˜¯é›†ç¾¤æ¶ˆè´¹ï¼Œæ­¤æ—¶æ¶ˆæ¯å‘å‡ºå»åå°†åªæœ‰ä¸€ä¸ªæ¶ˆè´¹è€…èƒ½è·å–æ¶ˆæ¯ã€‚

##### 3.2.7.2 å¹¿æ’­æ¨¡å¼

å¹¿æ’­æ¶ˆè´¹ï¼Œä¸€æ¡æ¶ˆæ¯è¢«å¤šä¸ªConsumeræ¶ˆè´¹ã€‚æ¶ˆæ¯ä¼šå‘ç»™Consume Groupä¸­çš„æ¯ä¸€ä¸ªæ¶ˆè´¹è€…è¿›è¡Œæ¶ˆè´¹ã€‚

#### 3.2.8ã€RocketMQçš„è·¯ç”±

#### 3.2.9ã€RocketMQçš„ç‰¹æ€§

##### 3.2.9.1ã€æ¶ˆæ¯é¡ºåº

æ¶ˆæ¯çš„é¡ºåºæŒ‡çš„æ˜¯æ¶ˆæ¯æ¶ˆè´¹æ—¶ï¼Œèƒ½æŒ‰ç…§å‘é€çš„é¡ºåºæ¥æ¶ˆè´¹ã€‚

RocketMQæ˜¯é€šè¿‡å°†â€œç›¸åŒIDçš„æ¶ˆæ¯å‘é€åˆ°åŒä¸€ä¸ªé˜Ÿåˆ—ï¼Œè€Œä¸€ä¸ªé˜Ÿåˆ—çš„æ¶ˆæ¯åªç”±ä¸€ä¸ªæ¶ˆè´¹è€…å¤„ç†â€œæ¥å®ç°é¡ºåºæ¶ˆæ¯

##### 3.2.9.2ã€æ¶ˆæ¯é‡å¤

###### 3.2.9.2.1ã€æ¶ˆæ¯é‡å¤çš„åŸå› 

æ¶ˆæ¯é¢†åŸŸæœ‰ä¸€ä¸ªå¯¹æ¶ˆæ¯æŠ•é€’çš„QoSï¼ˆæœåŠ¡è´¨é‡ï¼‰å®šä¹‰ï¼Œåˆ†ä¸ºï¼šæœ€å¤šä¸€æ¬¡ï¼ˆAt most onceï¼‰ã€è‡³å°‘ä¸€æ¬¡ï¼ˆAt least onceï¼‰ã€ä»…ä¸€æ¬¡ï¼ˆ Exactly onceï¼‰ã€‚

MQäº§å“éƒ½å£°ç§°è‡ªå·±åšåˆ°äº†At least onceã€‚æ—¢ç„¶æ˜¯è‡³å°‘ä¸€æ¬¡ï¼Œå°±æœ‰å¯èƒ½å‘ç”Ÿæ¶ˆæ¯é‡å¤ã€‚

æœ‰å¾ˆå¤šåŸå› å¯¼è‡´ï¼Œæ¯”å¦‚ï¼šç½‘ç»œåŸå› é—ªæ–­ï¼ŒACKè¿”å›å¤±è´¥ç­‰ç­‰æ•…éšœï¼Œç¡®è®¤ä¿¡æ¯æ²¡æœ‰ä¼ é€åˆ°æ¶ˆæ¯é˜Ÿåˆ—ï¼Œå¯¼è‡´æ¶ˆæ¯é˜Ÿåˆ—ä¸çŸ¥é“è‡ªå·±å·²ç»æ¶ˆè´¹è¿‡è¯¥æ¶ˆæ¯äº†ï¼Œå†æ¬¡å°†è¯¥æ¶ˆæ¯åˆ†å‘ç»™å…¶ä»–çš„æ¶ˆè´¹è€…

ä¸åŒçš„æ¶ˆæ¯é˜Ÿåˆ—å‘é€çš„ç¡®è®¤ä¿¡æ¯å½¢å¼ä¸åŒï¼šRocketMQè¿”å›ä¸€ä¸ªCONSUME_SUCCESSæˆåŠŸæ ‡å¿—ï¼ŒRabbitMQæ˜¯å‘é€ä¸€ä¸ªACKç¡®è®¤æ¶ˆæ¯

###### 3.2.9.2.2ã€æ¶ˆæ¯å»é‡

1ï¼‰ã€å»é‡åŸåˆ™ï¼šä½¿ç”¨ä¸šåŠ¡ç«¯é€»è¾‘ä¿æŒå¹‚ç­‰æ€§

å¹‚ç­‰æ€§ï¼šå°±æ˜¯ç”¨æˆ·å¯¹äºåŒä¸€æ“ä½œå‘èµ·çš„ä¸€æ¬¡è¯·æ±‚æˆ–è€…å¤šæ¬¡è¯·æ±‚çš„ç»“æœæ˜¯ä¸€è‡´çš„ï¼Œä¸ä¼šå› ä¸ºå¤šæ¬¡ç‚¹å‡»è€Œäº§ç”Ÿäº†å‰¯ä½œç”¨ï¼Œæ•°æ®åº“çš„ç»“æœéƒ½æ˜¯å”¯ä¸€çš„ï¼Œä¸å¯å˜çš„ã€‚

2ï¼‰ã€åªè¦ä¿æŒå¹‚ç­‰æ€§ï¼Œä¸ç®¡æ¥å¤šå°‘æ¡é‡å¤æ¶ˆæ¯ï¼Œæœ€åå¤„ç†çš„ç»“æœéƒ½ä¸€æ ·ï¼Œéœ€è¦ä¸šåŠ¡ç«¯æ¥å®ç°ã€‚

å»é‡ç­–ç•¥ï¼šä¿è¯æ¯æ¡æ¶ˆæ¯éƒ½æœ‰å”¯ä¸€ç¼–å·(æ¯”å¦‚å”¯ä¸€æµæ°´å·)ï¼Œä¸”ä¿è¯æ¶ˆæ¯å¤„ç†æˆåŠŸä¸å»é‡è¡¨çš„æ—¥å¿—åŒæ—¶å‡ºç°ã€‚

#### 3.2.10ã€RocketMQçš„åº”ç”¨åœºæ™¯

##### 1.å‰Šå³°å¡«è°·

æ¯”å¦‚å¦‚ç§’æ€ç­‰å¤§å‹æ´»åŠ¨æ—¶ä¼šå¸¦æ¥è¾ƒé«˜çš„æµé‡è„‰å†²ï¼Œå¦‚æœæ²¡åšç›¸åº”çš„ä¿æŠ¤ï¼Œå°†å¯¼è‡´ç³»ç»Ÿè¶…è´Ÿè·ç”šè‡³å´©æºƒã€‚å¦‚æœå› é™åˆ¶å¤ªè¿‡å¯¼è‡´è¯·æ±‚å¤§é‡å¤±è´¥è€Œå½±å“ç”¨æˆ·ä½“éªŒï¼Œå¯ä»¥åˆ©ç”¨MQ è¶…é«˜æ€§èƒ½çš„æ¶ˆæ¯å¤„ç†èƒ½åŠ›æ¥è§£å†³ã€‚

##### 2.å¼‚æ­¥è§£è€¦

é€šè¿‡ä¸Šã€ä¸‹æ¸¸ä¸šåŠ¡ç³»ç»Ÿçš„æ¾è€¦åˆè®¾è®¡ï¼Œæ¯”å¦‚ï¼šäº¤æ˜“ç³»ç»Ÿçš„ä¸‹æ¸¸å­ç³»ç»Ÿï¼ˆå¦‚ç§¯åˆ†ç­‰ï¼‰å‡ºç°ä¸å¯ç”¨ç”šè‡³å®•æœºï¼Œéƒ½ä¸ä¼šå½±å“åˆ°æ ¸å¿ƒäº¤æ˜“ç³»ç»Ÿçš„æ­£å¸¸è¿è½¬ã€‚

##### 3.é¡ºåºæ¶ˆæ¯

ä¸FIFOåŸç†ç±»ä¼¼ï¼ŒMQæä¾›çš„é¡ºåºæ¶ˆæ¯å³ä¿è¯æ¶ˆæ¯çš„å…ˆè¿›å…ˆå‡ºï¼Œå¯ä»¥åº”ç”¨äºäº¤æ˜“ç³»ç»Ÿä¸­çš„è®¢å•åˆ›å»ºã€æ”¯ä»˜ã€é€€æ¬¾ç­‰æµç¨‹ã€‚

##### 4.åˆ†å¸ƒå¼äº‹åŠ¡æ¶ˆæ¯

æ¯”å¦‚é˜¿é‡Œçš„äº¤æ˜“ç³»ç»Ÿã€æ”¯ä»˜çº¢åŒ…ç­‰åœºæ™¯éœ€è¦ç¡®ä¿æ•°æ®çš„æœ€ç»ˆä¸€è‡´æ€§ï¼Œéœ€è¦å¼•å…¥ MQ çš„åˆ†å¸ƒå¼äº‹åŠ¡ï¼Œæ—¢å®ç°äº†ç³»ç»Ÿä¹‹é—´çš„è§£è€¦ï¼Œåˆå¯ä»¥ä¿è¯æœ€ç»ˆçš„æ•°æ®ä¸€è‡´æ€§ã€‚

### 3.3 RocketMQé›†ç¾¤éƒ¨ç½²æ–¹å¼

#### 3.3.1ã€å•Materæ¨¡å¼

ä¼˜ç‚¹ï¼šé…ç½®ç®€å•ï¼Œæ–¹ä¾¿éƒ¨ç½²

ç¼ºç‚¹ï¼šé£é™©è¾ƒå¤§ï¼Œä¸€æ—¦Brokeré‡å¯æˆ–è€…å®•æœºï¼Œä¼šå¯¼è‡´æ•´ä¸ªæœåŠ¡ä¸å¯ç”¨

#### 3.3.2ã€å¤šMasteræ¨¡å¼

ä¸€ä¸ªé›†ç¾¤æ—  Slaveï¼Œå…¨æ˜¯ Masterï¼Œä¾‹å¦‚ 2 ä¸ª Master æˆ–è€… 3 ä¸ª Master

ä¼˜ç‚¹ï¼šé…ç½®ç®€å•ï¼Œå•ä¸ªMasterå®•æœºé‡å¯å¯¹åº”ç”¨æ²¡æœ‰å½±å“ã€‚æ¶ˆæ¯ä¸ä¼šä¸¢å¤±

ç¼ºç‚¹ï¼šå•å°æœºå™¨å®•æœºæœŸé—´ï¼Œè¿™å°æœºå™¨ä¸Šæ²¡æœ‰è¢«æ¶ˆè´¹çš„æ¶ˆæ¯åœ¨æ¢å¤ä¹‹å‰ä¸å¯è®¢é˜…ï¼Œæ¶ˆæ¯å®æ—¶æ€§ä¼šå—åˆ°å½±å“ã€‚

#### 3.3.3ã€å¤šMasterå¤šSlaveæ¨¡å¼ï¼ˆå¼‚æ­¥ï¼‰

æ¯ä¸ªMasteré…ç½®ä¸€ä¸ªSlaveï¼Œé‡‡ç”¨å¼‚æ­¥å¤åˆ¶æ–¹å¼ï¼Œä¸»å¤‡æœ‰çŸ­æš‚æ¶ˆæ¯å»¶è¿Ÿ

ä¼˜ç‚¹ï¼šå› ä¸ºMaster å®•æœºåï¼Œæ¶ˆè´¹è€…ä»ç„¶å¯ä»¥ä» Slaveæ¶ˆè´¹ï¼Œæ­¤è¿‡ç¨‹å¯¹åº”ç”¨é€æ˜ã€‚ä¸éœ€è¦äººå·¥å¹²é¢„ã€‚æ€§èƒ½åŒå¤š Master æ¨¡å¼å‡ ä¹ä¸€æ ·ã€‚

ç¼ºç‚¹ï¼šMasterå®•æœºåï¼Œä¼šä¸¢å¤±å°‘é‡ä¿¡æ¯

#### 3.3.4ã€å¤šMasterå¤šSlaveæ¨¡å¼ï¼ˆåŒæ­¥ï¼‰

æ¯ä¸ªMasteré…ç½®ä¸€ä¸ªSlaveï¼Œé‡‡ç”¨åŒæ­¥åŒå†™æ–¹å¼ï¼Œåªæœ‰ä¸»å’Œå¤‡éƒ½å†™æˆåŠŸï¼Œæ‰è¿”å›æˆåŠŸ

ä¼˜ç‚¹ï¼šæ•°æ®ä¸æœåŠ¡éƒ½æ— å•ç‚¹ï¼Œ Masterå®•æœºæƒ…å†µä¸‹ï¼Œæ¶ˆæ¯æ— å»¶è¿Ÿï¼ŒæœåŠ¡å¯ç”¨æ€§ä¸æ•°æ®å¯ç”¨æ€§éƒ½éå¸¸é«˜

ç¼ºç‚¹ï¼šæ€§èƒ½æ¯”å¼‚æ­¥å¤åˆ¶æ¨¡å¼ç•¥ä½ï¼Œå¤§çº¦ä½ 10%å·¦å³ï¼Œå‘é€å•ä¸ªæ¶ˆæ¯çš„ RTä¼šç•¥é«˜ã€‚ç›®å‰ä¸»å®•æœºåï¼Œå¤‡æœºä¸èƒ½è‡ªåŠ¨åˆ‡æ¢ä¸ºä¸»æœºï¼Œåç»­ä¼šæ”¯æŒè‡ªåŠ¨åˆ‡æ¢åŠŸèƒ½

### 3.4 RocketMQä¸‹è½½ä¸å®‰è£…

#### 3.4.1ã€ä¸‹è½½

å®˜æ–¹ç½‘ç«™ä¸‹è½½ï¼šhttp://rocketmq.apache.org/ï¼Œæˆ‘ä»¬æ‰¾åˆ° Quick Start è¿›å…¥å¿«é€Ÿå¼€å§‹é¡µé¢æ‰¾åˆ°ä¸‹è½½é“¾æ¥

<http://rocketmq.apache.org/docs/quick-start/>

æˆ‘ä»¬è¿™é‡Œä½¿ç”¨çš„æ˜¯rocketmq-all-4.4.0-bin-release.zip

![](assets/Snipaste_2019-09-05_10-22-35.png)

#### 3.4.2ã€å®‰è£…

å°†ä¸‹è½½å¥½çš„æ–‡ä»¶è§£å‹åˆ°D:\coding-softwareç›®å½•ä¸‹ï¼Œç„¶åé…ç½®ç¯å¢ƒå˜é‡ROCKETMQ_HOME=D:\coding-software\rocketmq-all-4.4.0-bin-release

![1548542074825](assets/1548542074825.png)



### 3.5 windowså¯åŠ¨æ“ä½œ 

#### 3.5.1 ã€å¯åŠ¨NAMESERVER

cmdå‘½ä»¤æ¡†æ‰§è¡Œè¿›å…¥è‡³â€˜MQæ–‡ä»¶å¤¹\binâ€™ä¸‹ï¼Œç„¶åæ‰§è¡Œ

```
start mqnamesrv.cmd
```



å¯åŠ¨NAMESERVERã€‚æˆåŠŸåä¼šå¼¹å‡ºæç¤ºæ¡†ï¼Œæ­¤æ¡†å‹¿å…³é—­ã€‚

![1548542221063](assets/1548542221063.png)



#### 3.5.2 ã€å¯åŠ¨BROKER

 cmdå‘½ä»¤æ¡†æ‰§è¡Œè¿›å…¥è‡³â€˜MQæ–‡ä»¶å¤¹\binâ€™ä¸‹ï¼Œç„¶åæ‰§è¡Œ

```
start mqbroker.cmd -n 127.0.0.1:9876 autoCreateTopicEnable=true
```



å¯åŠ¨BROKERã€‚æˆåŠŸåä¼šå¼¹å‡ºæç¤ºæ¡†ï¼Œæ­¤æ¡†å‹¿å…³é—­ã€‚

![1548542388881](assets/1548542388881.png)

æ³¨æ„ï¼šå‡å¦‚å¼¹å‡ºæç¤ºæ¡†æç¤ºâ€˜é”™è¯¯: æ‰¾ä¸åˆ°æˆ–æ— æ³•åŠ è½½ä¸»ç±» xxxxxxâ€™ã€‚æ‰“å¼€runbroker.cmdï¼Œç„¶åå°†â€˜%CLASSPATH%â€™åŠ ä¸Šè‹±æ–‡åŒå¼•å·ã€‚ä¿å­˜å¹¶é‡æ–°æ‰§è¡Œstartè¯­å¥ã€‚

![1548542513490](assets/1548542513490.png)

### 3.6 RocketMQæ’ä»¶éƒ¨ç½²

RocketMQæ’ä»¶æ˜¯ä¸€ä¸ªåŸºäºSpringBootç¼–å†™çš„å¯è§†åŒ–æ’ä»¶ï¼Œä¸»è¦ç”¨äºå¯¹RocketMQæä¾›äº†å¯è§†åŒ–çš„ç®¡ç†ç•Œé¢ã€‚

#### 3.6.1 ã€ä¸‹è½½

ä¸‹è½½åœ°å€ï¼šhttps://github.com/apache/rocketmq-externals/releases

![1548542721503](assets/1548542721503.png)

#### 3.6.2 ã€ç¼–è¯‘å¯åŠ¨

å…ˆä¿®æ”¹ä¸‹é…ç½®æ–‡ä»¶çš„nameserveråœ°å€

ä¿®æ”¹rocketmq-console\src\main\resources\application.propertiesï¼Œä¿®æ”¹å¦‚ä¸‹ï¼š

![1548878397947](assets/1548878397947.png)



è¿›å…¥â€˜\rocketmq-externals\rocketmq-consoleâ€™æ–‡ä»¶å¤¹ï¼Œ

```
mvn clean package -Dmaven.test.skip=true
```

ç¼–è¯‘ç”Ÿæˆã€‚ 

![1548542793935](assets/1548542793935.png)

ç¼–è¯‘æˆåŠŸä¹‹åï¼ŒCmdè¿›å…¥â€˜targetâ€™æ–‡ä»¶å¤¹ï¼Œæ‰§è¡Œ

```
java -jar rocketmq-console-ng-1.0.0.jar
```

å¯åŠ¨â€˜rocketmq-console-ng-1.0.0.jarâ€™ã€‚

#### 3.6.3 ã€æµ‹è¯•

è¾“å…¥åœ°å€http://127.0.0.1:8080/#/ops

![1548542862391](assets/1548542862391.png)



ä¸Šé¢æ˜¾ç¤ºçš„æ˜¯è‹±æ–‡ï¼Œå¦‚æœæƒ³æ˜¾ç¤ºä¸­æ–‡ï¼Œå¯ä»¥ç‚¹å‡»è¯­è¨€åˆ‡æ¢ï¼Œé€‰ä¸­Chinese

![1548542953245](assets/1548542953245.png)

åˆ‡æ¢åå¦‚ä¸‹å›¾ï¼š

![1548542995511](assets/1548542995511.png)



# 4ã€RocketMQå…¥é—¨

### é‡ç‚¹ï¼šç†Ÿæ‚‰RocketMQåŸºæœ¬apiçš„ä½¿ç”¨

### æ­¥éª¤åˆ†æ

RocketMQæ¶ˆæ¯æ¶ˆè´¹ç±»å‹æœ‰2ç§ç±»å‹ï¼Œæˆ‘ä»¬å…ˆå®ç°ä¸€æ¬¡é›†ç¾¤æ¶ˆæ¯æ¨¡å¼ï¼Œå†å®ç°å¹¿æ’­æ¨¡å¼ã€‚é›†ç¾¤æ¨¡å¼ä¹Ÿå°±æ˜¯æ¶ˆæ¯åªèƒ½åŒæ—¶è¢«ä¸€ä¸ªæ¶ˆè´¹è€…è¯»å–ï¼Œè€Œå¹¿æ’­æ¨¡å¼åˆ™å¯ä»¥åŒæ—¶è¢«æ‰€æœ‰æ¶ˆè´¹è€…è¯»å–ã€‚

æ¶ˆæ¯å‘é€æ­¥éª¤ï¼š

```properties
1.åˆ›å»ºDefaultMQProducer
2.è®¾ç½®Namesrvåœ°å€
3.å¯åŠ¨DefaultMQProducer
4.åˆ›å»ºæ¶ˆæ¯Message
5.å‘é€æ¶ˆæ¯,å‘é€åˆ°broker
6.å…³é—­DefaultMQProducer
```

æ¶ˆæ¯æ¶ˆè´¹æ­¥éª¤ï¼š

```properties
1.åˆ›å»ºDefaultMQPushConsumer
2.è®¾ç½®namesrvåœ°å€
3.è®¾ç½®subscribeï¼Œè¿™é‡Œæ˜¯è¦è¯»å–çš„ä¸»é¢˜ä¿¡æ¯
4.åˆ›å»ºæ¶ˆæ¯ç›‘å¬MessageListener
5.å¯åŠ¨æ¶ˆè´¹
6.è·å–æ¶ˆæ¯ä¿¡æ¯
7.è¿”å›æ¶ˆæ¯è¯»å–çŠ¶æ€
```

### åˆ›å»ºå·¥ç¨‹

#### 1ã€åˆ›å»ºçˆ¶å·¥ç¨‹ rocketMq-demo

é¡¹ç›®ç»“æ„å¦‚ä¸‹ï¼š

![](assets/1571449744.png)

é…ç½®pom.xml

```xml
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
    <modelVersion>4.0.0</modelVersion>

    <groupId>com.itheima</groupId>
    <artifactId>rocketMq-demo</artifactId>
    <packaging>pom</packaging>
    <version>1.0-SNAPSHOT</version>
    <modules>
        <module>springBoot-demo</module>
        <module>mq-demo</module>
    </modules>

    <parent>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-parent</artifactId>
        <version>2.1.3.RELEASE</version>
    </parent>

</project>
```



#### 2ã€åˆ›å»ºå­å·¥ç¨‹mq-demo

è¿™ä¸ªå­å·¥ç¨‹ç”¨æ¥æ¼”ç¤ºRocketMQçš„åŸç”ŸAPIçš„ä½¿ç”¨

åŠ å…¥ä¾èµ–

```xml
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
    <parent>
        <artifactId>rocketMq-demo</artifactId>
        <groupId>com.itheima</groupId>
        <version>1.0-SNAPSHOT</version>
    </parent>
    <modelVersion>4.0.0</modelVersion>

    <artifactId>mq-demo</artifactId>

    <dependencies>
        <dependency>
            <groupId>org.apache.rocketmq</groupId>
            <artifactId>rocketmq-client</artifactId>
            <version>4.4.0</version>
        </dependency>
        <dependency>
            <groupId>org.springframework</groupId>
            <artifactId>spring-context</artifactId>
        </dependency>
        <dependency>
            <groupId>org.projectlombok</groupId>
            <artifactId>lombok</artifactId>
        </dependency>
    </dependencies>
</project>
```



åˆ›å»ºå¸¸é‡ç±»

```java
package com.itheima.mq.constants;

public class SysConstants {
	//nameserverçš„åœ°å€
    public static final String NAME_SERVER = "127.0.0.1:9876";
}

```



### 4.1 ã€æ™®é€šæ¶ˆæ¯

#### 4.1.1  æ¶ˆæ¯ç”Ÿäº§è€…

åˆ›å»ºç±»Producerï¼Œ mainæ–¹æ³•ä»£ç å¦‚ä¸‹ï¼š

```java
package com.itheima.mq.base;

import com.itheima.mq.constants.SysConstants;
import org.apache.rocketmq.client.producer.DefaultMQProducer;
import org.apache.rocketmq.client.producer.SendResult;
import org.apache.rocketmq.client.producer.SendStatus;
import org.apache.rocketmq.common.message.Message;

/**
 * æ™®é€šæ¶ˆæ¯ç”Ÿäº§è€…
 */
public class Producer {
    public static void main(String[] args) throws Exception {
//        åˆ›å»ºä¸€ä¸ªæ¶ˆæ¯å‘é€å…¥å£å¯¹è±¡ï¼Œä¸»è¦ç”¨äºæ¶ˆæ¯å‘é€ï¼ŒæŒ‡å®šç”Ÿäº§è€…ç»„
        DefaultMQProducer producer = new DefaultMQProducer("producerGroup");
//        è®¾ç½®NameServeåœ°å€ï¼Œå¦‚æœæ˜¯é›†ç¾¤ç¯å¢ƒï¼Œç”¨åˆ†å·éš”å¼€
        producer.setNamesrvAddr(SysConstants.NAME_SERVER);
//        å¯åŠ¨å¹¶åˆ›å»ºæ¶ˆæ¯å‘é€ç»„ä»¶
        producer.start();
//        topicçš„åå­—
        String topic = "rocketDemobasic";
//        æ ‡ç­¾å
        String tag = "tag1";
//        è¦å‘é€çš„æ•°æ®
        String body = "hello,RocketMqï¼Œbasic1";
        Message message = new Message(topic,tag,body.getBytes());
        // å‘é€æ¶ˆæ¯
        SendResult result = producer.send(message,20000);
        System.out.println(result);

//        å…³é—­æ¶ˆæ¯å‘é€å¯¹è±¡
        producer.shutdown();


    }
}

```

æ‰§è¡Œä¸€æ¬¡mainæ–¹æ³•åï¼ŒæŸ¥çœ‹æ§åˆ¶å°ä¸»é¢˜ä¿¡æ¯ï¼Œå¦‚ä¸‹ï¼š

![](assets/Snipaste_2019-09-05_16-20-46.png)

è¿˜å¯ä»¥æŸ¥çœ‹åˆ°æ¶ˆæ¯

![](assets/Snipaste_2019-09-05_17-01-43.png)

#### 4.1.2 æ¶ˆæ¯æ¶ˆè´¹è€…

åˆ›å»ºç±»Consumerï¼Œmainæ–¹æ³•ä»£ç å¦‚ä¸‹ï¼š

```java
package com.itheima.mq.base;

import com.itheima.mq.constants.SysConstants;
import org.apache.rocketmq.client.consumer.DefaultMQPushConsumer;
import org.apache.rocketmq.client.consumer.listener.ConsumeConcurrentlyContext;
import org.apache.rocketmq.client.consumer.listener.ConsumeConcurrentlyStatus;
import org.apache.rocketmq.client.consumer.listener.MessageListenerConcurrently;
import org.apache.rocketmq.common.consumer.ConsumeFromWhere;
import org.apache.rocketmq.common.message.MessageExt;

import java.util.List;

/**
 * æ™®é€šæ¶ˆæ¯æ¶ˆè´¹è€…
 */
public class Consumer {

    public static void main(String[] args) throws Exception {
//        åˆ›å»ºä¸€ä¸ªæ¶ˆè´¹ç®¡ç†å¯¹è±¡ï¼Œå¹¶åˆ›å»ºæ¶ˆè´¹è€…ç»„åå­—
        DefaultMQPushConsumer consumerGroup = new DefaultMQPushConsumer("ConsumerGroup");
//        è®¾ç½®NameServeråœ°å€ï¼Œå¦‚æœæ˜¯é›†ç¾¤ç¯å¢ƒï¼Œç”¨é€—å·åˆ†éš”
        consumerGroup.setNamesrvAddr(SysConstants.NAME_SERVER);
//        è®¾ç½®è¦è¯»å–çš„æ¶ˆæ¯ä¸»é¢˜å’Œæ ‡ç­¾
        consumerGroup.subscribe("rocketDemobasic","*");
//        è®¾ç½®æ¶ˆè´¹è€… å¯ä»¥æ¶ˆè´¹çš„æ¶ˆæ¯æ¡æ•°
        consumerGroup.setConsumeMessageBatchMaxSize(1);
//        è¯»å–æ¶ˆæ¯çš„ä½ç½®
        //ConsumeFromWhere.CONSUME_FROM_LAST_OFFSET:ä»æœ€åä¸€ä¸ªè¯»å–
        //ConsumeFromWhere.CONSUME_FROM_FIRST_OFFSET:ä»ç¬¬ä¸€ä¸ªè¯»å–
        consumerGroup.setConsumeFromWhere(ConsumeFromWhere.CONSUME_FROM_FIRST_OFFSET);
//      è®¾ç½®å›è°ƒå‡½æ•°ï¼Œå¤„ç†æ¶ˆæ¯
        consumerGroup.registerMessageListener(new MessageListenerConcurrently() {
            @Override
            public ConsumeConcurrentlyStatus consumeMessage(List<MessageExt> msgs,
                                                            ConsumeConcurrentlyContext consumeConcurrentlyContext) {
                try{
//                    è¯»å–æ¶ˆæ¯è®°å½•
                    for (MessageExt messageExt : msgs) {
//                    è·å–æ¶ˆæ¯ä¸»é¢˜
                        String topic = messageExt.getTopic();
//                    è·å–æ¶ˆæ¯æ ‡ç­¾
                        String tags = messageExt.getTags();
//                    è·å–æ¶ˆæ¯ä½“å†…å®¹
                        String body = new String(messageExt.getBody(), "UTF-8");
                        System.out.println("topicï¼š"+topic+"ï¼Œtagsï¼š"+tags+"ï¼Œbodyï¼š"+body);
                    }

                }catch(Exception e){
                    e.printStackTrace();
                }
                return ConsumeConcurrentlyStatus.CONSUME_SUCCESS;
            }
        });
//      è¿è¡Œæ¶ˆæ¯æ¶ˆè´¹å¯¹è±¡
        consumerGroup.start();
    }
}

```



æ‰§è¡Œåçœ‹åˆ°æ§åˆ¶å°è¾“å‡º

![](assets/Snipaste_2019-09-05_17-04-26.png)





### 4.2ã€ é¡ºåºæ¶ˆæ¯

æ¶ˆæ¯æœ‰åºæŒ‡çš„æ˜¯å¯ä»¥æŒ‰ç…§æ¶ˆæ¯çš„å‘é€é¡ºåºæ¥æ¶ˆè´¹ã€‚RocketMQæ˜¯é€šè¿‡å°†â€œç›¸åŒIDçš„æ¶ˆæ¯å‘é€åˆ°åŒä¸€ä¸ªé˜Ÿåˆ—ï¼Œè€Œä¸€ä¸ªé˜Ÿåˆ—çš„æ¶ˆæ¯åªç”±ä¸€ä¸ªæ¶ˆè´¹è€…å¤„ç†â€œæ¥å®ç°é¡ºåºæ¶ˆæ¯ ã€‚

**å¦‚ä½•ä¿è¯é¡ºåº**

```properties
åœ¨MQçš„æ¨¡å‹ä¸­ï¼Œé¡ºåºéœ€è¦ç”±3ä¸ªé˜¶æ®µå»ä¿éšœï¼š
	1.æ¶ˆæ¯è¢«å‘é€æ—¶ä¿æŒé¡ºåº
	2.æ¶ˆæ¯è¢«å­˜å‚¨æ—¶ä¿æŒå’Œå‘é€çš„é¡ºåºä¸€è‡´
	3.æ¶ˆæ¯è¢«æ¶ˆè´¹æ—¶ä¿æŒå’Œå­˜å‚¨çš„é¡ºåºä¸€è‡´
```

å‘é€æ—¶ä¿æŒé¡ºåºæ„å‘³ç€å¯¹äºæœ‰é¡ºåºè¦æ±‚çš„æ¶ˆæ¯ï¼Œç”¨æˆ·åº”è¯¥åœ¨åŒä¸€ä¸ªçº¿ç¨‹ä¸­é‡‡ç”¨åŒæ­¥çš„æ–¹å¼å‘é€ã€‚å­˜å‚¨ä¿æŒå’Œå‘é€çš„é¡ºåºä¸€è‡´åˆ™è¦æ±‚åœ¨åŒä¸€çº¿ç¨‹ä¸­è¢«å‘é€å‡ºæ¥çš„æ¶ˆæ¯Aå’ŒBï¼Œå­˜å‚¨æ—¶åœ¨ç©ºé—´ä¸ŠAä¸€å®šåœ¨Bä¹‹å‰ã€‚è€Œæ¶ˆè´¹ä¿æŒå’Œå­˜å‚¨ä¸€è‡´åˆ™è¦æ±‚æ¶ˆæ¯Aã€Båˆ°è¾¾Consumerä¹‹åå¿…é¡»æŒ‰ç…§å…ˆAåBçš„é¡ºåºè¢«å¤„ç†ã€‚ 

#### 4.2.1 ã€ç”Ÿäº§è€…

æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªæ¶ˆæ¯ç”Ÿäº§è€…OrderProducer

Producerç«¯ç¡®ä¿æ¶ˆæ¯é¡ºåºå”¯ä¸€è¦åšçš„äº‹æƒ…å°±æ˜¯å°†æ¶ˆæ¯è·¯ç”±åˆ°ç‰¹å®šçš„é˜Ÿåˆ—ï¼Œåœ¨RocketMQä¸­ï¼Œé€šè¿‡MessageQueueSelectoræ¥å®ç°åˆ†åŒºçš„é€‰æ‹©ã€‚

æ¯”å¦‚å¦‚ä¸‹å®ç°å°±å¯ä»¥ä¿è¯ç›¸åŒçš„è®¢å•çš„æ¶ˆæ¯è¢«è·¯ç”±åˆ°ç›¸åŒçš„åˆ†åŒºï¼š

```java
long orderId ; //è®¢å•å·   
return mqs.get(orderId % mqs.size()); //ç”¨è®¢å•å· å’Œé˜Ÿåˆ—æ•°é‡ å–æ¨¡
```

å‡†å¤‡é¡ºåºæ¶ˆæ¯

```java
package com.itheima.mq.order.entity;

import lombok.AllArgsConstructor;
import lombok.Data;
import lombok.NoArgsConstructor;

import java.util.ArrayList;
import java.util.List;

@Data
@AllArgsConstructor
@NoArgsConstructor
public class Order {

    private Long orderId;
    private String desc;

    public static List<Order> buildOrders(){
        List<Order> list = new ArrayList<>();
        Order order1001a = new Order(1001L,"åˆ›å»º");
        Order order1004a = new Order(1004L,"åˆ›å»º");
        Order order1006a = new Order(1006L,"åˆ›å»º");
        Order order1009a = new Order(1009L,"åˆ›å»º");
        list.add(order1001a);
        list.add(order1004a);
        list.add(order1006a);
        list.add(order1009a);
        Order order1001b = new Order(1001L,"ä»˜æ¬¾");
        Order order1004b = new Order(1004L,"ä»˜æ¬¾");
        Order order1006b = new Order(1006L,"ä»˜æ¬¾");
        Order order1009b = new Order(1009L,"ä»˜æ¬¾");
        list.add(order1001b);
        list.add(order1004b);
        list.add(order1006b);
        list.add(order1009b);
        Order order1001c = new Order(1001L,"å®Œæˆ");
        Order order1006c = new Order(1006L,"å®Œæˆ");
        list.add(order1001c);
        list.add(order1006c);
        return list;
    }

}

```



æ¶ˆè´¹è€…ä»£ç å¦‚ä¸‹ï¼š

```java
package com.itheima.mq.order;

import com.itheima.mq.constants.SysConstants;
import com.itheima.mq.order.entity.Order;
import org.apache.rocketmq.client.producer.DefaultMQProducer;
import org.apache.rocketmq.client.producer.MessageQueueSelector;
import org.apache.rocketmq.client.producer.SendResult;
import org.apache.rocketmq.common.message.Message;
import org.apache.rocketmq.common.message.MessageQueue;

import java.util.List;

/**
 * é¡ºåºæ¶ˆæ¯ç”Ÿäº§è€…
 */
public class ProducerOrder {
        //nameserveråœ°å€
        private static String namesrvaddress= SysConstants.NAME_SERVER;

        public static void main(String[] args) throws Exception {
            //åˆ›å»ºDefaultMQProducer
            DefaultMQProducer producer = new DefaultMQProducer("order_producer");
            //è®¾ç½®namesrvåœ°å€
            producer.setNamesrvAddr(namesrvaddress);

            //å¯åŠ¨Producer
            producer.start();

            List<Order> orderList = Order.buildOrders();

            for (Order order : orderList) {

                String body = order.toString();
                //åˆ›å»ºæ¶ˆæ¯
                Message message = new Message("orderTopic","order",body.getBytes());
                //å‘é€æ¶ˆæ¯
                SendResult sendResult = producer.send(
                        message,
                        new MessageQueueSelector() {
                            /**
                             *
                             * @param mqs topicä¸­çš„é˜Ÿåˆ—é›†åˆ
                             * @param msg æ¶ˆæ¯å¯¹è±¡
                             * @param arg ä¸šåŠ¡å‚æ•°
                             * @return
                             */
                            @Override
                            public MessageQueue select(List<MessageQueue> mqs, Message msg, Object arg) {
                                //å‚æ•°æ˜¯è®¢å•idå·
                                Long orderId = (Long) arg;
                                //ç¡®å®šé€‰æ‹©çš„é˜Ÿåˆ—çš„ç´¢å¼•
                                long index = orderId % mqs.size();
                                return mqs.get((int) index);
                            }
                        },
                        order.getOrderId(),
                        20000);
                System.out.println("å‘é€ç»“æœ="+sendResult);

            }
            //å…³é—­Producer
            producer.shutdown();
        }
    }
```

#### 4.2.2 ã€æ¶ˆè´¹è€…

åˆ›å»ºä¸€ä¸ªæ¶ˆæ¯æ¶ˆè´¹è€…OrderConsumer,æ¶ˆæ¯ç›‘å¬ç”¨MessageListenerOrderlyæ¥å®ç°é¡ºåºæ¶ˆæ¯ï¼Œ

ä»£ç å¦‚ä¸‹ï¼š

```java
package com.itheima.mq.order;

import com.itheima.mq.constants.SysConstants;
import org.apache.rocketmq.client.consumer.DefaultMQPushConsumer;
import org.apache.rocketmq.client.consumer.listener.ConsumeOrderlyContext;
import org.apache.rocketmq.client.consumer.listener.ConsumeOrderlyStatus;
import org.apache.rocketmq.client.consumer.listener.MessageListenerOrderly;
import org.apache.rocketmq.common.consumer.ConsumeFromWhere;
import org.apache.rocketmq.common.message.MessageExt;

import java.util.List;
import java.util.concurrent.atomic.AtomicLong;

/**
 * é¡ºåºæ¶ˆæ¯ æ¶ˆè´¹è€…
 */
public class ConsumerOrder {
    public static void main(String[] args) throws Exception {

        DefaultMQPushConsumer consumer = new DefaultMQPushConsumer("order_consumer");
        consumer.setNamesrvAddr(SysConstants.NAME_SERVER);
        //ä»ç¬¬ä¸€ä¸ªå¼€å§‹æ¶ˆè´¹
        consumer.setConsumeFromWhere(ConsumeFromWhere.CONSUME_FROM_FIRST_OFFSET);

        consumer.subscribe("orderTopic","*");

        consumer.registerMessageListener(new MessageListenerOrderly() {
            @Override
            public ConsumeOrderlyStatus consumeMessage(List<MessageExt> msgs, ConsumeOrderlyContext context) {
                for (MessageExt msg : msgs) {

                    System.out.println("å½“å‰é˜Ÿåˆ—ï¼š"+context.getMessageQueue().getQueueId()+",æ¥æ”¶æ¶ˆæ¯ï¼š"+new String(msg.getBody()));
                }
                return ConsumeOrderlyStatus.SUCCESS;
            }

        });


//        consumer.registerMessageListener(new MessageListenerOrderly() {
//
//            AtomicLong consumerTimes = new AtomicLong(0);
//
//            @Override
//            public ConsumeOrderlyStatus consumeMessage(List<MessageExt> msgs, ConsumeOrderlyContext context) {
//                context.setAutoCommit(false);
//                System.out.printf(Thread.currentThread().getName() + "Receive New Message:"+msgs +"%n");
//                this.consumerTimes.incrementAndGet();
//                System.out.println(this.consumerTimes);
//                if((this.consumerTimes.get() % 2) == 0){
//                    return ConsumeOrderlyStatus.SUCCESS;
//                }else if((this.consumerTimes.get() % 3) ==  0){
//                    return ConsumeOrderlyStatus.ROLLBACK;
//                }else if((this.consumerTimes.get() % 4)== 0){
//                    return ConsumeOrderlyStatus.COMMIT;
//                }else if((this.consumerTimes.get() % 5)==0){
//                    context.setSuspendCurrentQueueTimeMillis(3000);
//                    return ConsumeOrderlyStatus.SUSPEND_CURRENT_QUEUE_A_MOMENT;
//                }
//                return ConsumeOrderlyStatus.SUCCESS;
//            }
//        });
        consumer.start();
        System.out.printf("æ¶ˆè´¹è€…å¯åŠ¨æˆåŠŸ.%n");
    }
}

```

æˆ‘ä»¬æ¥æŸ¥çœ‹æ§åˆ¶å°çš„è¾“å‡º,å¯ä»¥è¿”ç° åŒä¸€ä¸ªorderIdï¼Œè¢«åŒä¸€ä¸ªçº¿ç¨‹ï¼Œæœ‰é¡ºåºçš„æ¶ˆè´¹äº†

![](assets/orderconsumerlog.png)



### 4.3 ã€å»¶è¿Ÿæ¶ˆæ¯

#### ä½¿ç”¨é™åˆ¶

```java
 rocketmqæ”¯æŒå›ºå®šå»¶è¿Ÿç­‰çº§
 //"1s 5s 10s 30s 1m 2m 3m 4m 5m 6m 7m 8m 9m 10m 20m 30m 1h 2h"
```



#### 4.3.1ã€ç”Ÿäº§è€…

```java
package com.itheima.mq.delay;

import com.itheima.mq.constants.SysConstants;
import org.apache.rocketmq.client.producer.DefaultMQProducer;
import org.apache.rocketmq.client.producer.SendResult;
import org.apache.rocketmq.common.message.Message;

/**
 * å»¶è¿Ÿæ¶ˆæ¯ ç”Ÿäº§è€…
 */
public class ProducerDelay {

    public static void main(String[] args) throws Exception {
        DefaultMQProducer producer = new DefaultMQProducer("delay_producer");
        producer.setSendMsgTimeout(10000);
        //è®¾ç½®nameserver
        producer.setNamesrvAddr(SysConstants.NAME_SERVER);
        //ç”Ÿäº§è€…å¼€å¯
        producer.start();
        //åˆ›å»ºæ¶ˆæ¯å¯¹è±¡
        Message message = new Message("delayTopic","delay","hello world".getBytes());
        //è®¾ç½®å»¶è¿Ÿæ—¶é—´çº§åˆ«
        message.setDelayTimeLevel(2);
        //å‘é€æ¶ˆæ¯
        SendResult sendResult = producer.send(message,20000);
        System.out.println(sendResult);
        //ç”Ÿäº§è€…å…³é—­
        producer.shutdown();
    }
}

```



#### 4.3.2ã€æ¶ˆè´¹è€…

```java
package com.itheima.mq.delay;

import com.itheima.mq.constants.SysConstants;
import org.apache.rocketmq.client.consumer.DefaultMQPushConsumer;
import org.apache.rocketmq.client.consumer.listener.ConsumeConcurrentlyContext;
import org.apache.rocketmq.client.consumer.listener.ConsumeConcurrentlyStatus;
import org.apache.rocketmq.client.consumer.listener.MessageListenerConcurrently;
import org.apache.rocketmq.client.exception.MQClientException;
import org.apache.rocketmq.common.message.MessageExt;

import java.util.Date;
import java.util.List;

/**
 * å»¶è¿Ÿæ¶ˆæ¯ æ¶ˆè´¹è€…
 */
public class ConsumerDelay {

    public static void main(String[] args) throws Exception {
        //åˆ›å»ºæ¶ˆè´¹è€…å¯¹è±¡
        DefaultMQPushConsumer consumer = new DefaultMQPushConsumer("delay_consumer");
        //è®¾ç½®nameserver
        consumer.setNamesrvAddr(SysConstants.NAME_SERVER);
        //è®¾ç½®ä¸»é¢˜å’Œtag
        consumer.subscribe("delayTopic","*");
        //æ³¨å†Œæ¶ˆæ¯ç›‘å¬
        consumer.registerMessageListener(new MessageListenerConcurrently() {
            @Override
            public ConsumeConcurrentlyStatus consumeMessage(List<MessageExt> msgs, ConsumeConcurrentlyContext context) {
                for (MessageExt msg : msgs) {
                    long now = System.currentTimeMillis();
                    long storeTime = msg.getStoreTimestamp();
                    long dealy = now - storeTime;
                    Date date = new Date(storeTime);
                    Date nowdate = new Date(now);
                    System.out.println("now="+now);
                    System.out.println("storeTime="+storeTime);
                    System.out.println("delay="+dealy);
                    System.out.println("date="+date);
                    System.out.println("nowdate="+nowdate);
                    System.out.println("æ¶ˆæ¯IDï¼š"+msg.getMsgId()+"ï¼Œå»¶è¿Ÿæ—¶é—´ï¼š"+dealy);
                }
                return ConsumeConcurrentlyStatus.CONSUME_SUCCESS;
            }
        });
        //å¼€å¯æ¶ˆè´¹è€…
        consumer.start();
        System.out.println("æ¶ˆè´¹è€…å¯åŠ¨");
    }
}

```



### 4.4 ã€æ‰¹é‡å‘é€æ¶ˆæ¯

ä¸Šé¢å‘é€æ¶ˆæ¯ï¼Œæˆ‘ä»¬æµ‹è¯•çš„æ—¶å€™ï¼Œå¯ä»¥å‘ç°æ¶ˆæ¯åªæœ‰ä¸€ä¸ªæ¶ˆè´¹è€…èƒ½æ”¶åˆ°ï¼Œå¦‚æœæˆ‘ä»¬æƒ³å®ç°æ¶ˆæ¯å¹¿æ’­ï¼Œè®©æ¯ä¸ªæ¶ˆè´¹è€…éƒ½èƒ½æ”¶åˆ°æ¶ˆæ¯ä¹Ÿæ˜¯å¯ä»¥å®ç°çš„ã€‚è€Œä¸”ä¸Šé¢å‘é€æ¶ˆæ¯çš„æ—¶å€™ï¼Œæ¯æ¬¡éƒ½æ˜¯å‘é€å•æ¡Messageå¯¹è±¡ï¼Œèƒ½å¦æ‰¹é‡å‘é€å‘¢ï¼Ÿç­”æ¡ˆæ˜¯å¯ä»¥çš„ã€‚

#### 4.4.1 ã€ç”Ÿäº§è€…

åˆ›å»ºæ¶ˆæ¯ç”Ÿäº§è€…ï¼Œä»£ç å¦‚ä¸‹ï¼š

```java
package com.itheima.mq.batch;

import com.itheima.mq.constants.SysConstants;
import org.apache.rocketmq.client.producer.DefaultMQProducer;
import org.apache.rocketmq.client.producer.SendResult;
import org.apache.rocketmq.common.message.Message;

import java.util.ArrayList;
import java.util.List;

/**
 * æ‰¹é‡ ç”Ÿäº§è€…
 */
public class ProducerBatch {

    public static void main(String[] args) throws Exception {
        DefaultMQProducer producer = new DefaultMQProducer("batch_producer");
        //è®¾ç½®nameserver
        producer.setNamesrvAddr(SysConstants.NAME_SERVER);
        //ç”Ÿäº§è€…å¼€å¯
        producer.start();
        //åˆ›å»ºæ¶ˆæ¯å¯¹è±¡  é›†åˆ
        String topic = "batchTopic";
        String tag = "batchTag";
        List<Message> messageList = new ArrayList<>();
        Message message1 = new Message(topic,tag,"hello world1".getBytes());
        Message message2 = new Message(topic,tag,"hello world2".getBytes());
        Message message3 = new Message(topic,tag,"hello world3".getBytes());
        messageList.add(message1);
        messageList.add(message2);
        messageList.add(message3);
        //å‘é€æ¶ˆæ¯
        SendResult sendResult = producer.send(messageList,20000);
        System.out.println(sendResult);
        //ç”Ÿäº§è€…å…³é—­
        producer.shutdown();
    }
}

```

æ³¨æ„ï¼šå‘é€çš„æ€»æ¶ˆæ¯é•¿åº¦ ä¸èƒ½å¤§äº4M

#### 4.4.2 ã€æ¶ˆè´¹è€… 

æ¶ˆè´¹è€…ä»£ç æ²¡æœ‰ç‰¹æ®Šçš„åœ°æ–¹ï¼Œä»£ç å¦‚ä¸‹ï¼š

```java
package com.itheima.mq.batch;

import com.itheima.mq.constants.SysConstants;
import org.apache.rocketmq.client.consumer.DefaultMQPushConsumer;
import org.apache.rocketmq.client.consumer.listener.ConsumeConcurrentlyContext;
import org.apache.rocketmq.client.consumer.listener.ConsumeConcurrentlyStatus;
import org.apache.rocketmq.client.consumer.listener.MessageListenerConcurrently;
import org.apache.rocketmq.common.message.MessageExt;

import java.util.List;

/**
 * æ‰¹é‡æ¶ˆè´¹è€…
 */
public class ConsumerBatch {
    public static void main(String[] args) throws Exception {
        //åˆ›å»ºæ¶ˆè´¹è€…å¯¹è±¡
        DefaultMQPushConsumer consumer = new DefaultMQPushConsumer("batch_consumer");
        //è®¾ç½®nameserver
        consumer.setNamesrvAddr(SysConstants.NAME_SERVER);
        //è®¾ç½®ä¸»é¢˜å’Œtag
        consumer.subscribe("batchTopic","*");
        //æ³¨å†Œæ¶ˆæ¯ç›‘å¬
        consumer.registerMessageListener(new MessageListenerConcurrently() {
            @Override
            public ConsumeConcurrentlyStatus consumeMessage(List<MessageExt> msgs, ConsumeConcurrentlyContext context) {
                for (MessageExt msg : msgs) {
                    System.out.println("æ¶ˆæ¯IDï¼š"+msg.getMsgId()+","+msg.getTopic()+","+msg.getTags());
                }
                return ConsumeConcurrentlyStatus.CONSUME_SUCCESS;
            }
        });
        //å¼€å¯æ¶ˆè´¹è€…
        consumer.start();
        System.out.println("æ¶ˆè´¹è€…å¯åŠ¨");
    }
}

```



### 4.5 ã€å¹¿æ’­æ¨¡å¼å’Œé›†ç¾¤æ¨¡å¼

é›†ç¾¤æ¨¡å¼ï¼Œåªæœ‰ä¸€ä¸ªæ¶ˆè´¹è€…å¯ä»¥æ”¶åˆ°æ¶ˆæ¯

å¹¿æ’­æ¨¡å¼æ˜¯æ‰€æœ‰çš„æ¶ˆè´¹è€…éƒ½å¯ä»¥æ”¶åˆ°æ¶ˆæ¯ã€‚

éœ€è¦æŠŠã€æ¶ˆæ¯æ¨¡å¼ã€‘è®¾ç½®ä¸º ï¼šå¹¿æ’­æ¨¡å¼ï¼ŒåŒæ—¶å¼€å¯2ä¸ªä»¥ä¸Šçš„æ¶ˆè´¹è€…ï¼Œå†æ¬¡è¿è¡Œç”Ÿäº§è€…ï¼Œåªéœ€è¦åœ¨æ¶ˆè´¹æ–¹è®¾ç½®ä¸€ä¸‹æ¶ˆè´¹æ¨¡å¼å³å¯ã€‚

**æ³¨æ„ï¼šéœ€è¦æ¶ˆè´¹è€…å±äºä¸åŒçš„ã€æ¶ˆè´¹è€…ç»„ã€‘**

```
MessageModel.BROADCASTING:å¹¿æ’­æ¨¡å¼
MessageModel.CLUSTERINGï¼šé›†ç¾¤æ¨¡å¼
```

éœ€è¦åœ¨æ¶ˆè´¹è€…åŠ å…¥çš„ä»£ç å¦‚ä¸‹ï¼š

```java
//è®¾ç½®æ¶ˆè´¹æ¨¡å¼ä¸ºå¹¿æ’­æ¨¡å¼(BROADCASTING),é»˜è®¤ä¸ºé›†ç¾¤æ¨¡å¼(CLUSTERING)
consumer.setMessageModel(MessageModel.CLUSTERING);
```

æ³¨æ„ï¼š2ä¸ªæ¶ˆè´¹è€…çš„ åå­—éƒ½æ˜¯ä¸€æ ·çš„

æ¶ˆè´¹è€…1ï¼š

```java
package com.itheima.mq.broadcast;

import com.itheima.mq.constants.SysConstants;
import org.apache.rocketmq.client.consumer.DefaultMQPushConsumer;
import org.apache.rocketmq.client.consumer.listener.ConsumeConcurrentlyContext;
import org.apache.rocketmq.client.consumer.listener.ConsumeConcurrentlyStatus;
import org.apache.rocketmq.client.consumer.listener.MessageListenerConcurrently;
import org.apache.rocketmq.common.message.MessageExt;
import org.apache.rocketmq.common.protocol.heartbeat.MessageModel;

import java.util.List;

/**
 * æ‰¹é‡æ¶ˆè´¹è€…
 */
public class ConsumerBroadcast {
    public static void main(String[] args) throws Exception {
        //åˆ›å»ºæ¶ˆè´¹è€…å¯¹è±¡
        DefaultMQPushConsumer consumer = new DefaultMQPushConsumer("delay_consumer1");
        //è®¾ç½®nameserver
        consumer.setNamesrvAddr(SysConstants.NAME_SERVER);
        //è®¾ç½®ä¸»é¢˜å’Œtag
        consumer.subscribe("broadcastTopic","*");
        //è®¾ç½®æ¶ˆæ¯æ¨¡å¼ ä¸º å¹¿æ’­æ¨¡å¼
        consumer.setMessageModel(MessageModel.BROADCASTING);
        //æ³¨å†Œæ¶ˆæ¯ç›‘å¬
        consumer.registerMessageListener(new MessageListenerConcurrently() {
            @Override
            public ConsumeConcurrentlyStatus consumeMessage(List<MessageExt> msgs, ConsumeConcurrentlyContext context) {
                for (MessageExt msg : msgs) {
                    System.out.println("æ¶ˆè´¹è€…1ï¼šæ¶ˆæ¯IDï¼š"+msg.getMsgId()+"ï¼Œå†…å®¹"+new String(msg.getBody()));
                }
                return ConsumeConcurrentlyStatus.CONSUME_SUCCESS;
            }
        });
        //å¼€å¯æ¶ˆè´¹è€…
        consumer.start();
        System.out.println("æ¶ˆè´¹è€…å¯åŠ¨");
    }
}

```

æ¶ˆè´¹è€…2ï¼š

```java
package com.itheima.mq.broadcast;

import com.itheima.mq.constants.SysConstants;
import org.apache.rocketmq.client.consumer.DefaultMQPushConsumer;
import org.apache.rocketmq.client.consumer.listener.ConsumeConcurrentlyContext;
import org.apache.rocketmq.client.consumer.listener.ConsumeConcurrentlyStatus;
import org.apache.rocketmq.client.consumer.listener.MessageListenerConcurrently;
import org.apache.rocketmq.common.message.MessageExt;
import org.apache.rocketmq.common.protocol.heartbeat.MessageModel;

import java.util.List;

/**
 * æ‰¹é‡æ¶ˆè´¹è€…
 */
public class ConsumerBroadcast1 {
    public static void main(String[] args) throws Exception {
        //åˆ›å»ºæ¶ˆè´¹è€…å¯¹è±¡
        DefaultMQPushConsumer consumer = new DefaultMQPushConsumer("delay_consumer");
        //è®¾ç½®nameserver
        consumer.setNamesrvAddr(SysConstants.NAME_SERVER);
        //è®¾ç½®ä¸»é¢˜å’Œtag
        consumer.subscribe("broadcastTopic","*");
        //è®¾ç½®æ¶ˆæ¯æ¨¡å¼ ä¸º å¹¿æ’­æ¨¡å¼
        consumer.setMessageModel(MessageModel.BROADCASTING);
        //æ³¨å†Œæ¶ˆæ¯ç›‘å¬
        consumer.registerMessageListener(new MessageListenerConcurrently() {
            @Override
            public ConsumeConcurrentlyStatus consumeMessage(List<MessageExt> msgs, ConsumeConcurrentlyContext context) {
                for (MessageExt msg : msgs) {
                    System.out.println("æ¶ˆè´¹è€…2ï¼šæ¶ˆæ¯IDï¼š"+msg.getMsgId()+"ï¼Œå†…å®¹"+new String(msg.getBody()));
                }
                return ConsumeConcurrentlyStatus.CONSUME_SUCCESS;
            }
        });
        //å¼€å¯æ¶ˆè´¹è€…
        consumer.start();
        System.out.println("æ¶ˆè´¹è€…å¯åŠ¨");
    }
}

```

ç”Ÿäº§è€…

```java
package com.itheima.mq.broadcast;

import com.itheima.mq.constants.SysConstants;
import org.apache.rocketmq.client.producer.DefaultMQProducer;
import org.apache.rocketmq.client.producer.SendResult;
import org.apache.rocketmq.common.message.Message;

import java.util.ArrayList;
import java.util.List;

/**
 * æ‰¹é‡ ç”Ÿäº§è€…
 */
public class ProducerBroadcast {

    public static void main(String[] args) throws Exception {
        DefaultMQProducer producer = new DefaultMQProducer("delay_producer");
        //è®¾ç½®nameserver
        producer.setNamesrvAddr(SysConstants.NAME_SERVER);
        //ç”Ÿäº§è€…å¼€å¯
        producer.start();
        //åˆ›å»ºæ¶ˆæ¯å¯¹è±¡  é›†åˆ
        String topic = "broadcastTopic";
        String tag = "broad";
        List<Message> messageList = new ArrayList<>();
        Message message1 = new Message(topic,tag,"hello world1".getBytes());
        Message message2 = new Message(topic,tag,"hello world2".getBytes());
        Message message3 = new Message(topic,tag,"hello world3".getBytes());
        messageList.add(message1);
        messageList.add(message2);
        messageList.add(message3);
        //å‘é€æ¶ˆæ¯
        SendResult sendResult = producer.send(messageList);
        System.out.println(sendResult);
        //ç”Ÿäº§è€…å…³é—­
        producer.shutdown();
    }
}

```

å†æ¬¡å‘é€æ¶ˆæ¯å’Œæ¥æ”¶æ¶ˆæ¯ï¼Œå¯ä»¥å‘ç°å¤šä¸ªæ¶ˆè´¹è€…éƒ½èƒ½æ”¶åˆ°ç›¸åŒæ¶ˆæ¯ã€‚





# 5ã€SpringBootæ•´åˆRocketMQ

### 5.1 ã€åˆ›å»ºå·¥ç¨‹ 

å·¥ç¨‹åï¼šspringBoot-demo

![](assets/1571471374.png)

#### 5.1.1ã€å¼•å…¥ä¾èµ–

```xml
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
    <parent>
        <artifactId>rocketMq-demo</artifactId>
        <groupId>com.itheima</groupId>
        <version>1.0-SNAPSHOT</version>
    </parent>
    <modelVersion>4.0.0</modelVersion>

    <artifactId>springBoot-demo</artifactId>

    <dependencies>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-web</artifactId>
        </dependency>
        <dependency>
            <groupId>org.apache.rocketmq</groupId>
            <artifactId>rocketmq-spring-boot-starter</artifactId>
            <version>2.0.2</version>
        </dependency>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-test</artifactId>
            <scope>test</scope>
        </dependency>
        <dependency>
            <groupId>org.projectlombok</groupId>
            <artifactId>lombok</artifactId>
        </dependency>
    </dependencies>

</project>
```

#### 5.1.2ã€åˆ›å»ºå¯åŠ¨ç±»

```java
package com.itheima;

import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;

@SpringBootApplication
public class RocketDemoApplication {
    public static void main(String[] args) {
        SpringApplication.run(RocketDemoApplication.class,args);
    }
}

```

#### 5.1.3ã€åˆ›å»º é…ç½®æ–‡ä»¶

```yaml
rocketmq:
  name-server: 127.0.0.1:9876
  producer:
    send-message-timeout: 300000
    group: productgroup
server:
  port: 8081
```

### 5.2ã€æ™®é€šæ¶ˆæ¯

#### 5.2.1ã€ç”Ÿäº§è€…

åˆ›å»ºä¸€ä¸ªæµ‹è¯•ç±»ï¼Œä½œä¸ºæ¶ˆæ¯ç”Ÿäº§è€…

```java
package com.itheima.rocketdemo.test;

import org.apache.rocketmq.spring.core.RocketMQTemplate;
import org.junit.Test;
import org.junit.runner.RunWith;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.context.SpringBootTest;
import org.springframework.test.context.junit4.SpringRunner;

@RunWith(SpringRunner.class)
@SpringBootTest
public class Test1 {
    @Autowired
    private RocketMQTemplate rocketMQTemplate;

    /**
     * æ™®é€šæ¶ˆæ¯ï¼Œç”Ÿäº§è€…
     */
    @Test
    public void testSimpleSend(){

        rocketMQTemplate.convertAndSend(
                "testTopic",
                "è¿™æ˜¯SpringBootæµ‹è¯•æ¶ˆæ¯ï¼"+new Date());
    }
}

```



#### 5.2.2ã€æ¶ˆè´¹è€…

æ¶ˆè´¹è€…éœ€è¦ä½¿ç”¨ 

@Component

@RocketMQMessageListener ï¼Œéœ€è¦é…ç½®æ¶ˆè´¹è€…åå­—å’Œtopicåå­—

```java
package com.itheima.rocketdemo.consumer;

import org.apache.rocketmq.spring.annotation.RocketMQMessageListener;
import org.apache.rocketmq.spring.core.RocketMQListener;
import org.springframework.stereotype.Component;
import org.springframework.stereotype.Service;

@Component
@RocketMQMessageListener(consumerGroup = "myConsumer", topic = "testTopic")
public class RocketConsumer implements RocketMQListener<String>{
    @Override
    public void onMessage(String message) {
        System.out.println("æ¥æ”¶åˆ°æ¶ˆæ¯ï¼š="+message);
    }
}

```

### 5.3ã€é¡ºåºæ¶ˆæ¯

#### ç”Ÿäº§è€…

éœ€è¦è‡ªå·±ç¼–å†™æ¶ˆæ¯é€‰æ‹©é˜Ÿåˆ—çš„ä»£ç ï¼Œè¿™é‡Œæˆ‘ä»¬ç”¨ orderid å¯¹ é˜Ÿåˆ—æ€»æ•° å–æ¨¡ï¼šlong index = orderId % mqs.size();

```java
/**
     * é¡ºåºæ¶ˆæ¯ ç”Ÿäº§è€…
     */
    @Test
    public void testOrderlySend(){
        List<Order> orderList = Order.buildOrders();
        for (Order order : orderList) {
            //å‘é€æ¶ˆæ¯
            rocketMQTemplate.setMessageQueueSelector(new MessageQueueSelector() {
            @Override
            public MessageQueue select(List<MessageQueue> mqs, Message msg, Object arg) {
                    //å‚æ•°æ˜¯è®¢å•idå·
                    Long orderId = Long.valueOf((String)arg);
                    //ç¡®å®šé€‰æ‹©çš„é˜Ÿåˆ—çš„ç´¢å¼•
                    long index = orderId % mqs.size();
                    log.info("mqs is ::" + mqs.get((int) index));
                    return mqs.get((int) index);
                }
            });
            SendResult sendOrderly = rocketMQTemplate.syncSendOrderly("testTopicOrderLy",
                   new GenericMessage<>(order.toString()),order.getOrderId().toString());
            log.info("å‘é€ç»“æœ="+sendOrderly+",orderid :"+order.getOrderId());

        }

    }
```

#### æ¶ˆè´¹è€…

```java
package com.itheima.rocketdemo.consumer;

import lombok.extern.slf4j.Slf4j;
import org.apache.rocketmq.spring.annotation.ConsumeMode;
import org.apache.rocketmq.spring.annotation.RocketMQMessageListener;
import org.apache.rocketmq.spring.core.RocketMQListener;
import org.springframework.stereotype.Component;

/**
 * é¡ºåºæ¶ˆæ¯ ï¼Œæ¶ˆè´¹è€…
 */
@Slf4j
@Component
@RocketMQMessageListener(consumerGroup = "myConsumerOrderly",
        topic = "testTopicOrderLy",
        consumeMode = ConsumeMode.ORDERLY)
public class RocketConsumerOrderly implements RocketMQListener<String>{


    @Override
    public void onMessage(String message) {

        log.info("å½“å‰çº¿ç¨‹ï¼š"+Thread.currentThread().getName()+",æ¥æ”¶åˆ°æ¶ˆæ¯ï¼š="+message);
    }
}

```

### 5.4ã€å»¶è¿Ÿæ¶ˆæ¯

ç”Ÿäº§è€…

```java
/**
     * å»¶è¿Ÿæ¶ˆæ¯ç”Ÿäº§è€…
     */
    @Test
    public void testDelaySend(){
        SendResult sendResult = rocketMQTemplate.syncSend("testTopic",
                new GenericMessage("è¿™æ˜¯å»¶è¿Ÿæµ‹è¯•æ¶ˆæ¯ï¼"+new Date()),
                10000,
                4);
        log.info("sendResult=="+sendResult);
    }
```



æ¶ˆè´¹è€…ï¼Œå’Œæ™®é€šæ¶ˆæ¯çš„æ¶ˆè´¹è€…ä¸€æ ·ï¼Œæ— éœ€ä¿®æ”¹ã€‚



### 5.5ã€å¹¿æ’­æ¶ˆæ¯

æˆ‘ä»¬åˆ›å»ºæ–°çš„å·¥ç¨‹ä½œä¸ºæ–°çš„æ¶ˆè´¹è€…ï¼Œåˆ›å»ºå‡ºä¸€ä¸ªæ–°çš„å·¥ç¨‹springBoot-demo2ï¼Œå¦‚å›¾ï¼š

![](assets/1571479172.png)

è¿™ä¸ªå·¥ç¨‹ä¸­çš„å¯åŠ¨ç±»ã€é…ç½®æ–‡ä»¶æ¨¡ä»¿springBoot-demoå·¥ç¨‹å†™ã€‚åœ¨application.ymlä¸­é…ç½®server.port =8081å³å¯



æƒ³è¦å®ç°å¹¿æ’­åŠŸèƒ½ï¼Œåªéœ€è¦ä¿®æ”¹æ¶ˆè´¹è€…çš„ æ¶ˆæ¯ç±»å‹é€‰é¡¹ï¼Œå³ï¼š

```
messageModel = MessageModel.BROADCASTING
```

```java
package com.itheima.rocketdemo.consumer;

import lombok.extern.slf4j.Slf4j;
import org.apache.rocketmq.spring.annotation.MessageModel;
import org.apache.rocketmq.spring.annotation.RocketMQMessageListener;
import org.apache.rocketmq.spring.core.RocketMQListener;
import org.springframework.stereotype.Component;

@Slf4j
@Component
@RocketMQMessageListener(consumerGroup = "myConsumer", 
                         topic = "testTopic",
                         messageModel = MessageModel.BROADCASTING)
public class RocketConsumer implements RocketMQListener<String>{


    @Override
    public void onMessage(String message) {
       log.info("RocketConsumer,å½“å‰çº¿ç¨‹ï¼š"+Thread.currentThread().getName()+",æ¥æ”¶åˆ°æ¶ˆæ¯ï¼š="+message);
    }
}
```



å½“ä¿®æ”¹ä¸ºå¹¿æ’­æ¨¡å¼åï¼Œè¿™ä¸ªæ–°çš„æ¶ˆè´¹è€…ä¼šæ”¶åˆ°æ¶ˆæ¯





